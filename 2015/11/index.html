<!DOCTYPE html>
<!-- HTML 5 --><html lang="en-US">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="pingback" href="./../xmlrpc.php">
	
	<title>November | 2015 | Andrew Morgan on Databases</title>

<meta name="robots" content="max-image-preview:large">
	<style>img:is([sizes="auto" i], [sizes^="auto," i]) { contain-intrinsic-size: 3000px 1500px }</style>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="alternate" type="application/rss+xml" title="Andrew Morgan on Databases &raquo; Feed" href="./../feed/index.html">
<link rel="alternate" type="application/rss+xml" title="Andrew Morgan on Databases &raquo; Comments Feed" href="./../comments/feed/index.html">
		<!-- This site uses the Google Analytics by MonsterInsights plugin v9.2.2 - Using Analytics tracking - https://www.monsterinsights.com/ -->
		<!-- Note: MonsterInsights is not currently configured on this site. The site owner needs to authenticate with Google Analytics in the MonsterInsights settings panel. -->
					<!-- No tracking code set -->
				<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
/* <![CDATA[ */
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/15.0.3\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.clusterdb.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=81fb77f64976ac32efe42aab69fdb5e4"}};
/*! This file is auto-generated */
!function(i,n){var o,s,e;function c(e){try{var t={supportTests:e,timestamp:(new Date).valueOf()};sessionStorage.setItem(o,JSON.stringify(t))}catch(e){}}function p(e,t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(t,0,0);var t=new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data),r=(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillText(n,0,0),new Uint32Array(e.getImageData(0,0,e.canvas.width,e.canvas.height).data));return t.every(function(e,t){return e===r[t]})}function u(e,t,n){switch(t){case"flag":return n(e,"üè≥Ô∏è‚Äç‚ößÔ∏è","üè≥Ô∏è‚Äã‚ößÔ∏è")?!1:!n(e,"üá∫üá≥","üá∫‚Äãüá≥")&&!n(e,"üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø","üè¥‚ÄãÛ†Åß‚ÄãÛ†Å¢‚ÄãÛ†Å•‚ÄãÛ†ÅÆ‚ÄãÛ†Åß‚ÄãÛ†Åø");case"emoji":return!n(e,"üê¶‚Äç‚¨õ","üê¶‚Äã‚¨õ")}return!1}function f(e,t,n){var r="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?new OffscreenCanvas(300,150):i.createElement("canvas"),a=r.getContext("2d",{willReadFrequently:!0}),o=(a.textBaseline="top",a.font="600 32px Arial",{});return e.forEach(function(e){o[e]=t(a,e,n)}),o}function t(e){var t=i.createElement("script");t.src=e,t.defer=!0,i.head.appendChild(t)}"undefined"!=typeof Promise&&(o="wpEmojiSettingsSupports",s=["flag","emoji"],n.supports={everything:!0,everythingExceptFlag:!0},e=new Promise(function(e){i.addEventListener("DOMContentLoaded",e,{once:!0})}),new Promise(function(t){var n=function(){try{var e=JSON.parse(sessionStorage.getItem(o));if("object"==typeof e&&"number"==typeof e.timestamp&&(new Date).valueOf()<e.timestamp+604800&&"object"==typeof e.supportTests)return e.supportTests}catch(e){}return null}();if(!n){if("undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas&&"undefined"!=typeof URL&&URL.createObjectURL&&"undefined"!=typeof Blob)try{var e="postMessage("+f.toString()+"("+[JSON.stringify(s),u.toString(),p.toString()].join(",")+"));",r=new Blob([e],{type:"text/javascript"}),a=new Worker(URL.createObjectURL(r),{name:"wpTestEmojiSupports"});return void(a.onmessage=function(e){c(n=e.data),a.terminate(),t(n)})}catch(e){}c(n=f(s,u,p))}t(n)}).then(function(e){for(var t in e)n.supports[t]=e[t],n.supports.everything=n.supports.everything&&n.supports[t],"flag"!==t&&(n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&n.supports[t]);n.supports.everythingExceptFlag=n.supports.everythingExceptFlag&&!n.supports.flag,n.DOMReady=!1,n.readyCallback=function(){n.DOMReady=!0}}).then(function(){return e}).then(function(){var e;n.supports.everything||(n.readyCallback(),(e=n.source||{}).concatemoji?t(e.concatemoji):e.wpemoji&&e.twemoji&&(t(e.twemoji),t(e.wpemoji)))}))}((window,document),window._wpemojiSettings);
/* ]]> */
</script>
<style id="wp-emoji-styles-inline-css" type="text/css">img.wp-smiley, img.emoji {
		display: inline !important;
		border: none !important;
		box-shadow: none !important;
		height: 1em !important;
		width: 1em !important;
		margin: 0 0.07em !important;
		vertical-align: -0.1em !important;
		background: none !important;
		padding: 0 !important;
	}</style>
<link rel="stylesheet" id="wp-block-library-css" href="./../wp-includes/css/dist/block-library/style.min.css?ver=81fb77f64976ac32efe42aab69fdb5e4" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="plyr-css-css" href="./../wp-content/plugins/easy-video-player/lib/plyr.css?ver=81fb77f64976ac32efe42aab69fdb5e4" type="text/css" media="all">
<link rel="stylesheet" id="zeeSynergie_stylesheet-css" href="./../wp-content/themes/zeesynergie/style.css?ver=81fb77f64976ac32efe42aab69fdb5e4" type="text/css" media="all">
<link rel="stylesheet" id="zeeSynergie_colorscheme-css" href="./../wp-content/themes/zeesynergie/includes/css/colorschemes/blue.css?ver=81fb77f64976ac32efe42aab69fdb5e4" type="text/css" media="all">
<link rel="stylesheet" id="themezee_default_font-css" href="http://fonts.googleapis.com/css?family=Paytone+One&#038;ver=81fb77f64976ac32efe42aab69fdb5e4" type="text/css" media="all">
<script type="text/javascript" src="./../wp-content/plugins/easy-video-player/lib/plyr.min.js?ver=81fb77f64976ac32efe42aab69fdb5e4" id="plyr-js-js"></script>
<script type="text/javascript" src="./../wp-includes/js/jquery/jquery.min.js?ver=3.7.1" id="jquery-core-js"></script>
<script type="text/javascript" src="./../wp-includes/js/jquery/jquery-migrate.min.js?ver=3.4.1" id="jquery-migrate-js"></script>
<script type="text/javascript" src="./../wp-content/themes/zeesynergie/includes/js/jquery.cycle.all.min.js?ver=81fb77f64976ac32efe42aab69fdb5e4" id="zee_jquery-cycle-js"></script>
<link rel="https://api.w.org/" href="./../wp-json/index.html">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="./../xmlrpc.php?rsd">

<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09f}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style>
<style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>
<script type="text/javascript">
				//<![CDATA[
					jQuery(document).ready(function($) {
						$('#nav ul').css({display: 'none'}); // Opera Fix
						$('#nav li').hover(function(){
							$(this).find('ul:first').css({visibility: 'visible',display: 'none'}).show().css({opacity:0}).animate({opacity:1},400);
						},function(){
							$(this).find('ul:first').css({visibility: 'hidden'});
						});
					});
				//]]>
				</script><style type="text/css"></style>
<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
<style type="text/css" id="custom-background-css">body.custom-background { background-color: #89a5bf; }</style>
	<style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(3,122,221,.88);}</style>
</head>

<body class="archive date custom-background">
<div id="wrapper">

	<div id="header">

		<div id="head">
			<div id="logo">
									<a href="./../index.html"><h1>Andrew Morgan on Databases</h1></a>
                                        <!-- <a href=".//"><h1>MySQL Cluster, Replication, Fabric...</h1></a>  ZXZX -->					
							</div>
			<div id="socialmedia_icons">
				<a href="http://twitter.com/andrewmorgan"><img src="./../wp-content/themes/zeesynergie/images/icons/twitter.png" alt="twitter"></a><a href="http://www.facebook.com/andrewjamesmorgan"><img src="./../wp-content/themes/zeesynergie/images/icons/facebook.png" alt="facebook"></a><a href="https://plus.google.com/u/0/100605473697871424413/posts"><img src="./../wp-content/themes/zeesynergie/images/icons/googleplus.png" alt="googleplus"></a><a href="http://www.linkedin.com/profile/view?id=16709956"><img src="./../wp-content/themes/zeesynergie/images/icons/linkedin.png" alt="linkedin"></a><a href="http://www.flickr.com/photos/andrewjamesmorgan/"><img src="./../wp-content/themes/zeesynergie/images/icons/flickr.png" alt="flickr"></a><a href="http://www.youtube.com/channel/UCodtDakJ4VdeSCzS3P3rIsw"><img src="./../wp-content/themes/zeesynergie/images/icons/youtube.png" alt="youtube"></a>				<div class="clear"></div>
			</div>
			<div class="clear"></div>
		</div>
		
		<div id="navi_container">
			<div id="navi">
				<ul id="nav" class="menu">
<li class="page_item page-item-1011"><a href="./../about/index.html">About</a></li>
</ul>			</div>
		</div>
		<div class="clear"></div>
	</div>
	
	<div id="container">
	
			<div id="custom_header">
			<img src="./../wp-content/uploads/2015/06/cropped-ClusterDB-logo-header.png">
		</div>
	
	<div id="wrap">
		<div id="content">
		
		<h2 class="arh">Archive for November 30, 2015</h2>
				
					<div id="post-4143" class="post-4143 post type-post status-publish format-standard hentry category-mongodb">
				
				<div class="postmeta">	<div class="postmeta_links">
		<a href="./../author/andrew/index.html" title="Posts by andrew" rel="author">andrew</a> |
		<a href="./../mongodb/analytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug/index.html">November 30, 2015</a>
			</div>
	<div class="postcomments">
		<a href="./../mongodb/analytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug/index.html#respond">No comments</a>	</div>
	<div class="clear"></div>
</div>

				<h2 class="post-title"><a href="./../mongodb/analytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug/index.html" rel="bookmark">Analytics with MongoDB: Haymarket Media + Joins Coming in MongoDB 3.2 ‚Äì London MUG</a></h2>
				
				<div class="entry">
										<p>At the November <a href="http://www.meetup.com/London-MongoDB-User-Group/events/225879378/" target="_blank">London MongoDB Meetup Group</a> we had 2 sessions. </p>
<p>The first was by Pete Dignan, explaining how PistonHeads (part of Haymarket Media) use MongoDB to perform analytics to make sure that their dealers get the best possible value. This was a really interesting presentation and Pete has kindly agreed to share his charts here&#8230;</p>
<p><iframe src="//www.slideshare.net/slideshow/embed_code/key/4viruIuzSqqDbB" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> </p>
<div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/andrewjamesmorgan/pistonheads-use-of-mongodb-for-analytics" title="PistonHead&#x27;s use of MongoDB for Analytics" target="_blank">PistonHead&#x27;s use of MongoDB for Analytics</a> </strong>. </div>
<p>You can also find out more about <a href="https://www.mongodb.com/blog/post/leaf-in-the-wild-haymarket-migrates-from-mysql-to-mongodb-achieving-8x-higher-platform-efficiency">PistonHead&#8217;s use of MongoDB and their migration from MySQL in this article</a>.</p>
<p>I then presented on the new <code>$lookup</code> feature from MongoDB 3.2 (adding the ability to perform left outer joins between MongoDB collections) together with other enhancements to the <a href="https://docs.mongodb.org/manual/core/aggregation-introduction/" target="_blank">MongoDB Aggregation Framework pipeline</a>. You can view the charts here:</p>
<p><iframe src="//www.slideshare.net/slideshow/embed_code/key/8HWzMZ3A2SSmHc" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> </p>
<div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/andrewjamesmorgan/joins-and-other-mongodb-32-aggregation-enhancements" title="Joins and Other MongoDB 3.2 Aggregation Enhancements" target="_blank">Joins and Other MongoDB 3.2 Aggregation Enhancements</a>.</strong>
</div>
<p>For more details on <code>$lookup</code> check out the <a href="https://www.mongodb.com/presentations/webinar-joins-and-other-aggregation-enhancements-coming-in-mongodb-3-2" target="_blank">webinar replay</a> or <a href="./../mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2/index.html" target="_blank">read this post</a>.</p>
<p>The <a href="http://www.meetup.com/London-MongoDB-User-Group/events/225879378/" target="_blank">London MongoDB Meetup Group</a> meets every 6-8 weeks and it&#8217;s a great opportunity learn what&#8217;s happening with MongoDB as well as how people use it ‚Äì if you live or work near London then it would be great to see you there.</p>
					<div class="clear"></div>
									</div>
		<br>
		<script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
   		<a href="http://twitter.com/share" class="twitter-share-button" data-url=".//mongodb/analytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug" data-via="wpbeginner" data-text="Analytics with MongoDB: Haymarket Media + Joins Coming in MongoDB 3.2 ‚Äì London MUG" data-related="syedbalkhi:Founder of WPBeginner" data-count="horizontal">Tweet</a>
		<br>
		<!-- <g:plusone size="medium" href=".//mongodb/analytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug"></g:plusone> -->
		<div class="g-plusone" data-annotation="inline" data-width="300"></div>
		<!-- Place this tag after the last +1 button tag. -->
		<script type="text/javascript">(function() {
    				var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    				po.src = 'https://apis.google.com/js/plusone.js';
    				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  			})();</script>
		<br>
		<script type="text/javascript" src="http://platform.linkedin.com/in.js"></script><script type="in/share" data-url=".//mongodb/analytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug" data-counter="right"></script>
		<br>
		<iframe src="http://www.facebook.com/plugins/like.php?href=.%2F%2Fmongodb%2Fanalytics-with-mongodb-haymarket-media-joins-coming-in-mongodb-3-2-london-mug&amp;layout=standard&amp;show_faces=true&amp;width=450&amp;action=like&amp;colorscheme=light" scrolling="no" frameborder="0" allowtransparency="true" style="border:none; overflow:hidden; width:450px; height:60px;">
		</iframe>

<!-- ZXZX -->
				<div class="postinfo">Category: <a href="./../category/mongodb/index.html" rel="category tag">MongoDB</a> | 
</div>

			</div>			<div id="post-4140" class="post-4140 post type-post status-publish format-standard hentry category-mongodb tag-aggregation tag-join tag-mongodb tag-mongodb-3-2">
				
				<div class="postmeta">	<div class="postmeta_links">
		<a href="./../author/andrew/index.html" title="Posts by andrew" rel="author">andrew</a> |
		<a href="./../mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2/index.html">November 6, 2015</a>
			</div>
	<div class="postcomments">
		<a href="./../mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2/index.html#respond">No comments</a>	</div>
	<div class="clear"></div>
</div>

				<h2 class="post-title"><a href="./../mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2/index.html" rel="bookmark">Joins and Other Aggregation Enhancements in MongoDB 3.2</a></h2>
				
				<div class="entry">
										<p>This post looks at the aggregation enhancements being introduced in MongoDB 3.2 ‚Äì most notably <code>$lookup</code> which implements left-outer equi-joins in the MongoDB Aggregation Framework. The material was originally published in a <a href="https://www.mongodb.com/blog/post/joins-and-other-aggregation-enhancements-coming-in-mongodb-3-2-part-1-of-3-introduction" title="Joins and Other Aggregation Enhancements Coming in MongoDB 3.2">MongoDB blog series</a>.</p>
<p>It starts with an introduction to analyzing data with MongoDB. We then explain why joins are sometimes useful for MongoDB ‚Äì in spite of the strengths of the document model ‚Äì and how developers have been working without them. It then works through examples of building aggregation pipelines ‚Äì including using the operators added in MongoDB 3.2. After that, we look at how geolocation data can be included as well as what to do when you reach the limit of what can be done using a single pipeline ‚Äì including adding wrapper code. Finally, there&#8217;s a summary of some of the limitations of the Aggregation Framework and reasons why you might supplement it with a full visualization solution such as <a href="http://www.tableau.com/">Tableau</a> together with MongoDB&#8217;s Connector for BI (Business Intelligence) ‚Äì also new in MongoDB 3.2.</p>
<h2>
<a id="user-content-disclaimer" class="anchor" href="#disclaimer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Disclaimer</h2>
<p>MongoDB&#8217;s product plans are for informational purposes only. MongoDB&#8217;s plans may change and you should not rely on them for delivery of a specific feature at a specific time.</p>
<h2>
<a id="user-content-real-time-analytics-and-search" class="anchor" href="#real-time-analytics-and-search" aria-hidden="true"><span class="octicon octicon-link"></span></a>Real-Time Analytics and Search</h2>
<p>With the emergence of new data sources such as social media, mobile applications and sensor-equipped ‚ÄúInternet of Things‚Äù networks, organizations can extend analytics to deliver real-time insight and discovery into such areas as operational performance, customer satisfaction, and competitor behavior.</p>
<p>Time to value is everything. For example, having access to real-time customer sentiment or fleet tracking is of little benefit unless the data can be analyzed and reported in real-time.</p>
<p>MongoDB 3.2 aims to extend the options for performing analytics on the live, operational database ‚Äì ensuring that answers are delivered quickly, and reflect current data. Work that would previously have needed to be done on the client side can now be performed by the database ‚Äì freeing the developer to focus on new features. </p>
<h2>
<a id="user-content-the-case-for-joins" class="anchor" href="#the-case-for-joins" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Case for Joins</h2>
<p>MongoDB‚Äôs document data model is flexible and provides developers many options in terms of modeling their data. Most of the time all the data for a record tends to be located in a single document. For the operational application, accessing data is simple, high performance, and easy to scale with this approach. </p>
<p>When it comes to analytics and reporting, however, it is possible that the data you need to access spans multiple collections. This is illustrated in Figure 1, where the <code>_id</code> field of multiple documents from the <code>products</code> collection is included in a document from the <code>orders</code> collection. For a query to analyze orders and details about their associated products, it must fetch the order document from the <code>orders</code> collection and then use the embedded references to read multiple documents from the <code>products</code> collection. Prior to MongoDB 3.2, this work is implemented in application code. However, this adds complexity to the application and requires multiple round trips to the database, which can impact performance.</p>
<p><a href="https://camo.githubusercontent.com/381f8bf25b13cc8ed82c317cf62a273a5a555a10/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f53696d756c617465644c6566744f757465724a6f696e732e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/381f8bf25b13cc8ed82c317cf62a273a5a555a10/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f53696d756c617465644c6566744f757465724a6f696e732e706e67" alt="Application-Layer simulation of joins between documents" title="Application-Layer simulation of joins between documents" data-canonical-src="http://clusterdb.com/upload/SimulatedLeftOuterJoins.png" style="max-width:100%;"></a><br>
<em>Figure 1: Application-Layer simulation of joins between documents</em></p>
<p>MongoDB 3.2 introduces the <code>$lookup</code> operator that can now be included as a stage in an aggregation pipeline. With this approach, the work of combining data from the orders and products collections is implemented within the database, and as part of a broader aggregation pipeline that performs other processing in a single query. As a result, there is less work to code in the application, and fewer round trips to the database. You can think about $lookup as equivalent to a left outer equi-join.</p>
<h3>
<a id="user-content-aside---what-is-a-left-outer-equi-join" class="anchor" href="#aside---what-is-a-left-outer-equi-join" aria-hidden="true"><span class="octicon octicon-link"></span></a>Aside &#8211; What is a Left Outer Equi-Join?</h3>
<p>A left outer equi-join produces a result set that contains data for all documents from the left table (collection) together with data from the right table (collection) for documents where there is a match with documents from the left table (collection). This is illustrated in Figure 2.</p>
<p><a href="https://camo.githubusercontent.com/3fd23b37ace2ba08cfb3744f7744ab11de630aa1/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f4c6566745f4f757465725f4a6f696e2e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/3fd23b37ace2ba08cfb3744f7744ab11de630aa1/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f4c6566745f4f757465725f4a6f696e2e706e67" alt="Left-Outer join between tables/collections" title="Left-Outer join between tables/collections" data-canonical-src="http://clusterdb.com/upload/Left_Outer_Join.png" style="max-width:100%;"></a><br>
<em>Figure 2: Left-Outer join between collections</em></p>
<h2>
<a id="user-content-mongodbs-aggregation-framework" class="anchor" href="#mongodbs-aggregation-framework" aria-hidden="true"><span class="octicon octicon-link"></span></a>MongoDB&#8217;s Aggregation Framework</h2>
<p>The Aggregation Framework is a pipeline for data aggregation modeled on the concept of data processing pipelines. Documents enter a multi-stage pipeline that transforms the documents into aggregated results. The pipeline consists of stages; each stage transforms the documents as they pass through.</p>
<p>In general, each successive stage reduces the volume of data; removing information that isn&#8217;t needed and combining other data to produce summarized results.</p>
<p>Figure 3 shows a conceptual model for the Aggregation Framework pipeline. This is what&#8217;s happening at each stage:</p>
<ul>
<li>On the left-hand side/start of the pipeline is the original collection contents ‚Äì each record (document) containing a number of shapes (keys), each with a particular color (value)</li>
<li>The <code>$match</code> stage filters out any documents that don&#8217;t contain a red diamond</li>
<li>The <code>$project</code> stage adds a new ‚Äúsquare‚Äù attribute with a value computed from the value (color) of the snowflake and triangle attributes</li>
<li>The <code>$lookup</code> stage (new in 3.2 &#8211; more details later) performs a left-outer join with another collection, with the star being the comparison key. This creates new documents which contain everything from the previous stage but augmented with data from any document from the second collection containing a matching colored star (i.e., the blue and yellow stars had matching ‚Äúlookup‚Äù values, whereas the red star had none).</li>
<li>Finally, the <code>$group</code> stage groups the data by the color of the square and produces statistics (sum, average and standard deviation) for each group.</li>
</ul>
<p><a href="https://camo.githubusercontent.com/4861c2c6c2d2e68978a8e8c7e97c3e8b3dd0114c/687474703a2f2f7777772e636c757374657264622e636f6d2f75706c6f61642f4d6f6e676f44425f4167677265676174696f6e5f506970656c696e652e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/4861c2c6c2d2e68978a8e8c7e97c3e8b3dd0114c/687474703a2f2f7777772e636c757374657264622e636f6d2f75706c6f61642f4d6f6e676f44425f4167677265676174696f6e5f506970656c696e652e706e67" alt="MongoDB Aggregation Framework Pipeline" title="MongoDB Aggregation Framework Pipeline" data-canonical-src=".//upload/MongoDB_Aggregation_Pipeline.png" style="max-width:100%;"></a><br>
<em>Figure 3: MongoDB Aggregation Framework pipeline</em></p>
<p>This is the full set of aggregation stages:</p>
<ul>
<li>
<code>$match</code> ‚Äì Filter documents</li>
<li>
<code>$geoNear</code> ‚Äì Sort documents based on geographic proximity</li>
<li>
<code>$project</code> ‚Äì Reshape documents (remove or rename keys or add new data based on calculations on the existing data)</li>
<li>
<code>$lookup</code> ‚Äì <strong>Coming in 3.2</strong> ‚Äì Left-outer joins</li>
<li>
<code>$unwind</code> ‚Äì Expand documents (for example create multiple documents where each contains one element from an array from the original document)</li>
<li>
<code>$group</code> ‚Äì Summarize documents</li>
<li>
<code>$sample</code> ‚Äì Randomly selects a subset of documents</li>
<li>
<code>$sort</code> ‚Äì Order documents</li>
<li>
<code>$skip</code> ‚Äì Jump over a number of documents</li>
<li>
<code>$limit</code> ‚Äì Limit number of documents</li>
<li>
<code>$redact</code> ‚Äì Restrict sensitive content from documents</li>
<li>
<code>$out</code> ‚Äì <em>Coming in 3.2</em>* ‚Äì store the results in a new collection</li>
</ul>
<p>The details can be found in the <a href="http://docs.mongodb.org/manual/reference/operator/aggregation-pipeline/" title="Pipeline Aggregation Stages">documentation</a>.</p>
<h3>
<a id="user-content-new-aggregation-operators-in-mongodb-32" class="anchor" href="#new-aggregation-operators-in-mongodb-32" aria-hidden="true"><span class="octicon octicon-link"></span></a>New Aggregation Operators in MongoDB 3.2</h3>
<p>There are operators used within each stage and this set is being extended in MongoDB 3.2 to include:</p>
<ul>
<li>Array operations
<ul>
<li>
<code>$slice</code>, <code>$arrayElemAt</code>, <code>$concatArrays</code>, <code>$isArray</code>, <code>$filter</code>, <code>$min</code>, <code>$max</code>, <code>$avg</code> and <code>$sum</code> (some of these were previously available in a <code>$group</code> stage but not in <code>$project</code>
</li>
</ul>
</li>
<li>Standard Deviations
<ul>
<li>
<code>$stdDevSamp</code> (based on a sample) and <code>$stdDevPop</code> (based on the complete population)</li>
</ul>
</li>
<li>Square Root
<ul>
<li><code>$sqrt</code></li>
</ul>
</li>
<li>Absolute (make +ve) value
<ul>
<li><code>$abs</code></li>
</ul>
</li>
<li>Rounding numbers
<ul>
<li>
<code>$trunc</code>, <code>$ceil</code>, <code>$floor</code>
</li>
</ul>
</li>
<li>Logarithms
<ul>
<li>
<code>$log</code>, <code>$log10</code>, <code>$ln</code>
</li>
</ul>
</li>
<li>Raise to power
<ul>
<li><code>$pow</code></li>
</ul>
</li>
<li>Natural Exponent
<ul>
<li><code>$exp</code></li>
</ul>
</li>
</ul>
<p>Further details on these new operators can be found in the MongoDB 3.2 Release Notes.</p>
<h2>
<a id="user-content-lookup--left-outer-equi-joins" class="anchor" href="#lookup--left-outer-equi-joins" aria-hidden="true"><span class="octicon octicon-link"></span></a>$lookup ‚Äì Left Outer Equi-Joins</h2>
<p>Figure 4 illustrates the syntax for performing the join:</p>
<ul>
<li>
<code>leftCollection</code> is the collection that the aggregation is being performed on and is the <em>left</em> collection in the join</li>
<li>
<code>from</code> identifies the collection that it will be joined with ‚Äì the <em>right</em> collection (<code>rightCollection</code> in this case)</li>
<li>
<code>localField</code> specifies the key from the original/left collection ‚Äì <code>leftVal</code>
</li>
<li>
<code>foreignField</code> specifies the key from the right collection ‚Äì <code>rightVal</code>
</li>
<li>
<code>as</code> indicates that the data from the right collection should be embedded within the resulting documents as an array called <code>embeddedData</code>
</li>
</ul>
<p><a href="https://camo.githubusercontent.com/fdd7e396bb467e8d541289fa983c8cd334e64e77/687474703a2f2f7777772e636c757374657264622e636f6d2f75706c6f61642f246c6f6f6b75705f4d6f6e676f44425f4a6f696e732e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/fdd7e396bb467e8d541289fa983c8cd334e64e77/687474703a2f2f7777772e636c757374657264622e636f6d2f75706c6f61642f246c6f6f6b75705f4d6f6e676f44425f4a6f696e732e706e67" alt="$lookup ‚Äì Left-Outer Joins for MongoDB" title="$lookup ‚Äì Left-Outer Joins for MongoDB" data-canonical-src=".//upload/$lookup_MongoDB_Joins.png" style="max-width:100%;"></a><br>
<em>Figure 4: $lookup ‚Äì Left-Outer Joins for MongoDB</em></p>
<p>In the follow-on blogs in this series, you‚Äôll see how the data from a home sales collection (containing details of each home sale, including the property‚Äôs postal code) is joined with data from a postal code collection (containing postal codes and their geographical location). This produces documents that contain the original home sale information augmented with the coordinates of the property. In this case, the ‚Äúhomesales‚Äù collection is the left-collection and ‚Äúpostcodes‚Äù the right-collection; the ‚Äúpostcode‚Äù field from each collection is the <code>localField</code> which is matched with the <code>foreignField</code>.</p>
<h2>
<a id="user-content-worked-examples" class="anchor" href="#worked-examples" aria-hidden="true"><span class="octicon octicon-link"></span></a>Worked Examples</h2>
<h3>
<a id="user-content-the-data-set" class="anchor" href="#the-data-set" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Data Set</h3>
<p>The examples use two data sets, the first being a comprehensive set of home sale data for a town and the second being a mapping from postal codes to geospatial locations for that same town.</p>
<p><em>For those interested, the imported data sets needed some cleaning up to make this walkthrough more useful &#8211; <a href="http://clusterdb.com/upload/DataSet_CleanUp.html" title="Cleaning up the data sets">the steps are described here</a>.</em></p>
<p>The two data sets can be checked using the <code>mongo</code> shell:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.findOne()
{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>56005dd980c3678b19792b7f<span class="pl-pds">"</span></span>),
  <span class="pl-s"><span class="pl-pds">"</span>amount<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">9000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>date<span class="pl-pds">"</span></span><span class="pl-k">:</span> ISODate(<span class="pl-s"><span class="pl-pds">"</span>1996-09-19T00:00:00Z<span class="pl-pds">"</span></span>),
  <span class="pl-s"><span class="pl-pds">"</span>address<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">"</span>nameOrNumber<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">25</span>,
    <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>NORFOLK PARK COTTAGES<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>town<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MAIDENHEAD<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>county<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>WINDSOR AND MAIDENHEAD<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 7DR<span class="pl-pds">"</span></span>
  }
}

db.postcodes.findOne()
{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>5600521e50fa77da54dfc0d2<span class="pl-pds">"</span></span>),
  <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 0AA<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
      <span class="pl-c1">51.525605</span>,
      <span class="pl-k">-</span><span class="pl-c1">0.700974</span>
    ]
  }
}</pre>
</div>
<p>An even better option to understand the contents of these collections is to use <a href="https://youtu.be/3w9HVFh1hRs">MongoDB Compass</a> (to be released with MongoDB 3.2). Figure 1 shows an overview of the <code>homeSales</code> collection and Figure 2 delves into its <code>address</code> sub-document.</p>
<p>
These datasets (the <code>homeSales</code> and <code>postcodes</code> collections) can be <a href="./../upload/SalesData.tar.gz" name="datasets for $lookup" alt="Download datasets used in this post">downloaded here</a>.
</p>
<p><a href="https://camo.githubusercontent.com/76e2d4bcdb1802474cc548b8b58891d3ed02d04b/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d706173735f566965775f6f665f686f6d6553616c65732e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/76e2d4bcdb1802474cc548b8b58891d3ed02d04b/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d706173735f566965775f6f665f686f6d6553616c65732e706e67" alt="MongoDB Compass View of homeSales Collection" title="MongoDB Compass View of homeSales Collection" data-canonical-src="http://clusterdb.com/upload/Compass_View_of_homeSales.png" style="max-width:100%;"></a><br>
<em>Figure 1: MongoDB Compass View of the homeSales Collection</em></p>
<p><a href="https://camo.githubusercontent.com/e0738db602146dee4a570b4e578274cc5746f97c/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d706173735f686f6d6553616c65735f416464726573732e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/e0738db602146dee4a570b4e578274cc5746f97c/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d706173735f686f6d6553616c65735f416464726573732e706e67" alt="Viewing Sub-Documents With MongoDB Compass" title="Viewing Sub-Documents With MongoDB Compass" data-canonical-src="http://clusterdb.com/upload/Compass_homeSales_Address.png" style="max-width:100%;"></a><br>
<em>Figure 2: Viewing Sub-Documents With MongoDB Compass</em></p>
<h3>
<a id="user-content-building-the-first-pipeline" class="anchor" href="#building-the-first-pipeline" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the First Pipeline</h3>
<p>As the error messages from complex pipelines aren&#8217;t always very specific, it makes sense to start with a simple pipeline and then check the results before moving onto the next.</p>
<p>As a collection&#8217;s indexes are only used for the beginning stages in the pipeline (before any transformations are performed), it is often sensible to reduce the result set as much as possible with a <code>$match</code> stage to filter out any unnecessary documents. Ideally, the match would be against the sharding key so that fewer shards need to be included. For the first pipeline stage the cheaper property sales are going to excluded and so it would help to have a secondary index on the <code>amount</code> key:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.createIndex({amount<span class="pl-k">:</span> <span class="pl-c1">1</span>})</pre>
</div>
<p>The first stage in the pipeline then filters out any sales of less than ¬£3,000,000:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
  {$match<span class="pl-k">:</span> {
    amount<span class="pl-k">:</span> {$gte<span class="pl-k">:</span><span class="pl-c1">3000000</span>}}
  }
  ])</pre>
</div>
<p>The results can then be inspected to understand what will flow into the next stage in the pipeline:</p>
<div class="highlight highlight-source-js">
<pre>{
    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>56005dda80c3678b19799e52<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>amount<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3000000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>date<span class="pl-pds">"</span></span><span class="pl-k">:</span> ISODate(<span class="pl-s"><span class="pl-pds">"</span>2012-04-19T00:00:00Z<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>address<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>nameOrNumber<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>TEMPLE FERRY PLACE<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MILL LANE<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>town<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>county<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>WINDSOR AND MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 5ND<span class="pl-pds">"</span></span>
      }
    },

...

    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>56005dda80c3678b19799e5c<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>amount<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">5425000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>date<span class="pl-pds">"</span></span><span class="pl-k">:</span> ISODate(<span class="pl-s"><span class="pl-pds">"</span>1999-03-15T00:00:00Z<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>address<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>nameOrNumber<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>2 - 3<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>THE SWITCHBACK<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>town<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>county<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>WINDSOR AND MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 7RJ<span class="pl-pds">"</span></span>
      }
    }</pre>
</div>
<p>In the next stage, a left-outer join is performed ‚Äì using <code>$lookup</code> ‚Äì to find documents from the <code>postcodes</code> collection with a matching postcode so that the geographic location can be determined:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
  {$match<span class="pl-k">:</span> {
    amount<span class="pl-k">:</span> {$gte<span class="pl-k">:</span><span class="pl-c1">3000000</span>}}
  }, 
  {$lookup<span class="pl-k">:</span> {
    from<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcodes<span class="pl-pds">"</span></span>, 
    localField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>address.postcode<span class="pl-pds">"</span></span>,
    foreignField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span>,
    as<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode_docs<span class="pl-pds">"</span></span>}
  }
])</pre>
</div>
<p>Which yields these results:</p>
<div class="highlight highlight-source-js">
<pre>{
    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>56005dda80c3678b19799e52<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>amount<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3000000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>date<span class="pl-pds">"</span></span><span class="pl-k">:</span> ISODate(<span class="pl-s"><span class="pl-pds">"</span>2012-04-19T00:00:00Z<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>address<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>nameOrNumber<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>TEMPLE FERRY PLACE<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MILL LANE<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>town<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>county<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>WINDSOR AND MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 5ND<span class="pl-pds">"</span></span>
      },
      <span class="pl-s"><span class="pl-pds">"</span>postcode_docs<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        {
          <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>560053e280c3678b1978b293<span class="pl-pds">"</span></span>),
          <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 5ND<span class="pl-pds">"</span></span>,
          <span class="pl-s"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
            <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
              <span class="pl-c1">51.549516</span>,
              <span class="pl-k">-</span><span class="pl-c1">0.80702</span>
            ]
          }
        }
      ]
    },

...

      <span class="pl-s"><span class="pl-pds">"</span>postcode_docs<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        {
          <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>560053e280c3678b1978b524<span class="pl-pds">"</span></span>),
          <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 7RJ<span class="pl-pds">"</span></span>,
          <span class="pl-s"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
            <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
              <span class="pl-c1">51.536848</span>,
              <span class="pl-k">-</span><span class="pl-c1">0.735835</span>
            ]
          }
        }
      ]
    }</pre>
</div>
<p>The pipeline can then be extended with a <code>$project</code> stage to refactor the documents, removing any information that isn&#8217;t needed. The documents are then sorted in reverse-price order:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
  {$match<span class="pl-k">:</span> {
    amount<span class="pl-k">:</span> {$gte<span class="pl-k">:</span><span class="pl-c1">3000000</span>}}
  }, 
  {$lookup<span class="pl-k">:</span> {
    from<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcodes<span class="pl-pds">"</span></span>, 
    localField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>address.postcode<span class="pl-pds">"</span></span>,
    foreignField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span>,
    as<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode_docs<span class="pl-pds">"</span></span>}
  },
  {$project<span class="pl-k">:</span> {
    _id<span class="pl-k">:</span> <span class="pl-c1">0</span>,
    saleDate<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$date<span class="pl-pds">"</span></span>,
    price<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>,
    address<span class="pl-k">:</span> <span class="pl-c1">1</span>,
    location<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$postcode_docs.location<span class="pl-pds">"</span></span>}},
  {$sort<span class="pl-k">:</span>
    {
      price<span class="pl-k">:</span> <span class="pl-k">-</span><span class="pl-c1">1</span>
    }}
])</pre>
</div>
<p>The address and physical location of every home sale, starting with the most expensive is then shown:</p>
<div class="highlight highlight-source-js">
<pre>    {
      <span class="pl-s"><span class="pl-pds">"</span>address<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>nameOrNumber<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>2 - 3<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>THE SWITCHBACK<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>town<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>county<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>WINDSOR AND MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 7RJ<span class="pl-pds">"</span></span>
      },
      <span class="pl-s"><span class="pl-pds">"</span>saleDate<span class="pl-pds">"</span></span><span class="pl-k">:</span> ISODate(<span class="pl-s"><span class="pl-pds">"</span>1999-03-15T00:00:00Z<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">5425000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        {
          <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
          <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
            <span class="pl-c1">51.536848</span>,
            <span class="pl-k">-</span><span class="pl-c1">0.735835</span>
          ]
        }
      ]
    },

...

    {
      <span class="pl-s"><span class="pl-pds">"</span>address<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>nameOrNumber<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>TEMPLE FERRY PLACE<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MILL LANE<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>town<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>county<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>WINDSOR AND MAIDENHEAD<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 5ND<span class="pl-pds">"</span></span>
      },
      <span class="pl-s"><span class="pl-pds">"</span>saleDate<span class="pl-pds">"</span></span><span class="pl-k">:</span> ISODate(<span class="pl-s"><span class="pl-pds">"</span>2012-04-19T00:00:00Z<span class="pl-pds">"</span></span>),
      <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3000000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        {
          <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
          <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
            <span class="pl-c1">51.549516</span>,
            <span class="pl-k">-</span><span class="pl-c1">0.80702</span>
          ]
        }
      ]
    }</pre>
</div>
<h3>
<a id="user-content-building-further-pipelines" class="anchor" href="#building-further-pipelines" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building Further Pipelines</h3>
<p>If all of the sales need to be analyzed (rather than just the most expensive few) then there would be too many results from the previous pipeline to be easily understood. For this reason, the pipeline is modified so that extra analysis and aggregation is performed within the database. This can be done using a <code>$group</code> stage ‚Äì in this case to produce sales statistics by year:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
  {
    $group<span class="pl-k">:</span> 
    {
      _id<span class="pl-k">:</span> {$year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$date<span class="pl-pds">"</span></span>},
      higestPrice<span class="pl-k">:</span> {$max<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      lowestPrice<span class="pl-k">:</span> {$min<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      averagePrice<span class="pl-k">:</span> {$avg<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      priceStdDev<span class="pl-k">:</span> {$stdDevPop<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>}
    }
  },
  {
    $sort<span class="pl-k">:</span> {_id<span class="pl-k">:</span> <span class="pl-c1">1</span>}
  }
])</pre>
</div>
<div class="highlight highlight-source-js">
<pre>    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1995</span>,
      <span class="pl-s"><span class="pl-pds">"</span>higestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1000000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">12000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">114059.35206869633</span>,
      <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">81540.50490801703</span>
    },

...

    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>,
      <span class="pl-s"><span class="pl-pds">"</span>higestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1688000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">125000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">451413.23917137476</span>,
      <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">228293.6005201898</span>
    }

</pre>
</div>
<p>Note that this is using the <code>$stdDevPop</code> (standard deviation) aggregation operator being introduced in MongoDB 3.2.</p>
<p>There&#8217;s more precision than needed for some of the keys and so a common pattern can be employed ‚Äì use a final <code>$project</code> stage to tidy up the data:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
  {
    $group<span class="pl-k">:</span> 
    {
      _id<span class="pl-k">:</span> {$year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$date<span class="pl-pds">"</span></span>},
      higestPrice<span class="pl-k">:</span> {$max<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      lowestPrice<span class="pl-k">:</span> {$min<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      averagePrice<span class="pl-k">:</span> {$avg<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      priceStdDev<span class="pl-k">:</span> {$stdDevPop<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>}
    }
  },
  {
    $sort<span class="pl-k">:</span> {_id<span class="pl-k">:</span> <span class="pl-c1">1</span>}
  },
  {
    $project<span class="pl-k">:</span>
    {
      _id<span class="pl-k">:</span> <span class="pl-c1">1</span>,
      higestPrice<span class="pl-k">:</span> <span class="pl-c1">1</span>,
      lowestPrice<span class="pl-k">:</span> <span class="pl-c1">1</span>,
      averagePrice<span class="pl-k">:</span> {$trunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$averagePrice<span class="pl-pds">"</span></span>},
      priceStdDev<span class="pl-k">:</span> {$trunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceStdDev<span class="pl-pds">"</span></span>}
    }
  }
])</pre>
</div>
<div class="highlight highlight-source-js">
<pre>
    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1995</span>,
      <span class="pl-s"><span class="pl-pds">"</span>higestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1000000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">12000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">114059</span>,
      <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">81540</span>
    },

...

    {
      <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>,
      <span class="pl-s"><span class="pl-pds">"</span>higestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1688000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">125000</span>,
      <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">451413</span>,
      <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">228293</span>
    }</pre>
</div>
<p>It often makes sense to store the results in a new collection ‚Äì either because the results will be reused many times or that subsequent aggregation pipelines will reference them. This is simple to achieve using a <code>$out</code> stage; note that:</p>
<ul>
<li>If the target collection already exists then its contents will be overwritten</li>
<li>If used then the <code>$out</code> must be the final stage in the pipeline</li>
</ul>
<p>The following example writes the results to a collection called <code>annualHomePrices</code>:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
  {
    $group<span class="pl-k">:</span> 
    {
      _id<span class="pl-k">:</span> {$year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$date<span class="pl-pds">"</span></span>},
      highestPrice<span class="pl-k">:</span> {$max<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      lowestPrice<span class="pl-k">:</span> {$min<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      averagePrice<span class="pl-k">:</span> {$avg<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>},
      priceStdDev<span class="pl-k">:</span> {$stdDevPop<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$amount<span class="pl-pds">"</span></span>}
    }
  },
  {
    $sort<span class="pl-k">:</span> {_id<span class="pl-k">:</span> <span class="pl-c1">1</span>}
  },
  {
    $project<span class="pl-k">:</span>
    {
      _id<span class="pl-k">:</span> <span class="pl-c1">0</span>,
      year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$_id<span class="pl-pds">"</span></span>,
      highestPrice<span class="pl-k">:</span> <span class="pl-c1">1</span>,
      lowestPrice<span class="pl-k">:</span> <span class="pl-c1">1</span>,
      averagePrice<span class="pl-k">:</span> {$trunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$averagePrice<span class="pl-pds">"</span></span>},
      priceStdDev<span class="pl-k">:</span> {$trunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceStdDev<span class="pl-pds">"</span></span>}
    }
  },
  {
    $out<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>annualHomePrices<span class="pl-pds">"</span></span>
  }
])</pre>
</div>
<div class="highlight highlight-source-js">
<pre><span class="pl-k">&gt;</span> db.annualHomePrices.findOne()
{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>560957ac29a5574d557d426d<span class="pl-pds">"</span></span>),
  <span class="pl-s"><span class="pl-pds">"</span>highestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1000000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">12000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">114059</span>,
  <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">81540</span>,
  <span class="pl-s"><span class="pl-pds">"</span>year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1995</span>
}</pre>
</div>
<p>These &#8220;interim&#8221; results could then be used to build further result sets ‚Äì without the need to run all of that processing again. As an example, using a simple <code>$project</code> stage, the gap between the highest and lowest house sale can be calculated for each year:</p>
<div class="highlight highlight-source-js">
<pre>db.annualHomePrices.aggregate([
  {$project<span class="pl-k">:</span> 
    {
      Year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$year<span class="pl-pds">"</span></span>,
      hightToLowPriceGap<span class="pl-k">:</span> {
        $subtract<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">"</span>$highestPrice<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>$lowestPrice<span class="pl-pds">"</span></span>]
      },
      _id<span class="pl-k">:</span> <span class="pl-c1">0</span>
    }
  }
])</pre>
</div>
<div class="highlight highlight-source-js">
<pre>{
   <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2012</span>,
   <span class="pl-s"><span class="pl-pds">"</span>hightToLowPriceGap<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2923000</span>
},
{
   <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2013</span>,
   <span class="pl-s"><span class="pl-pds">"</span>hightToLowPriceGap<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">5092250</span>
},
{
   <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2014</span>,
   <span class="pl-s"><span class="pl-pds">"</span>hightToLowPriceGap<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3883050</span>
},
{
  <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>,
  <span class="pl-s"><span class="pl-pds">"</span>hightToLowPriceGap<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1563000</span>
}</pre>
</div>
<p>As a final stage in this post, a pipeline is built to find the postal code and geographic location of the most expensive house sale for each of the recorded years:<br>
Perform a <code>$sort</code> on the full <code>homeSales</code> data set so that the documents are ordered from most expensive sale first<br>
<code>$group</code> the results based on the year of the home sale, deriving the <code>priciestPostCode</code> from the <code>$first</code> document in that group (year). Because the documents were sorted on price before entering the <code>group</code> stage, the first document is also the one with the highest price<br>
<code>$lookup</code> the postal code in the <code>postcodes</code> collection to get the geolocation data<br>
<code>$sort</code> the results by year<br>
<code>$project</code> just the data that is of interest</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
    {
      $sort<span class="pl-k">:</span> {amount<span class="pl-k">:</span> <span class="pl-k">-</span><span class="pl-c1">1</span>}
    },
    {
      $group<span class="pl-k">:</span>
      {
        _id<span class="pl-k">:</span> {$year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$date<span class="pl-pds">"</span></span>},
        priciestPostCode<span class="pl-k">:</span> {$first<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$address.postcode<span class="pl-pds">"</span></span>}
      }
    },
    {
      $lookup<span class="pl-k">:</span>
      {
        from<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcodes<span class="pl-pds">"</span></span>,
        localField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>priciestPostCode<span class="pl-pds">"</span></span>,
        foreignField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span>,
        as<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>locationData<span class="pl-pds">"</span></span>
      }
    },
    {
      $sort<span class="pl-k">:</span> {_id<span class="pl-k">:</span> <span class="pl-k">-</span><span class="pl-c1">1</span>}
    },
    {
      $project<span class="pl-k">:</span>
      {
        _id<span class="pl-k">:</span> <span class="pl-c1">0</span>,
        Year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$_id<span class="pl-pds">"</span></span>,
        PostCode<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priciestPostCode<span class="pl-pds">"</span></span>,
        <span class="pl-c1">Location</span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$locationData.location<span class="pl-pds">"</span></span>
      }
    }
  ])</pre>
</div>
<div class="highlight highlight-source-js">
<pre>{
  <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>,
  <span class="pl-s"><span class="pl-pds">"</span>PostCode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 9UD<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>Location<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    {
      <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        <span class="pl-c1">51.558455</span>,
        <span class="pl-k">-</span><span class="pl-c1">0.756023</span>
      ]
    }
  ]
},
{
  <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2014</span>,
  <span class="pl-s"><span class="pl-pds">"</span>PostCode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 1UP<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>Location<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    {
      <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        <span class="pl-c1">51.51407</span>,
        <span class="pl-k">-</span><span class="pl-c1">0.704414</span>
      ]
    }
  ]
},
...</pre>
</div>
<h2>
<a id="user-content-adding-some-coding-glue-and-geolocation" class="anchor" href="#adding-some-coding-glue-and-geolocation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding Some Coding Glue and Geolocation</h2>
<p>Obviously, there are limits as to how much can be achieved with a single aggregation pipeline but with the addition of just a little code outside of the database (in this example, JavaScript in the <code>mongo</code> shell), additional results can be produced.</p>
<p>We start by repeating an aggregation from the previous section but store the data in a collection so that we can build upon those results:</p>
<div class="highlight highlight-source-js">
<pre>db.homeSales.aggregate([
    {
      $sort<span class="pl-k">:</span> {amount<span class="pl-k">:</span> <span class="pl-k">-</span><span class="pl-c1">1</span>}
    },
    {
      $group<span class="pl-k">:</span>
      {
        _id<span class="pl-k">:</span> {$year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$date<span class="pl-pds">"</span></span>},
        priciestPostCode<span class="pl-k">:</span> {$first<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$address.postcode<span class="pl-pds">"</span></span>}
      }
    },
    {
      $lookup<span class="pl-k">:</span>
      {
        from<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcodes<span class="pl-pds">"</span></span>,
        localField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>priciestPostCode<span class="pl-pds">"</span></span>,
        foreignField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span>,
        as<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>locationData<span class="pl-pds">"</span></span>
      }
    },
    {
      $sort<span class="pl-k">:</span> {_id<span class="pl-k">:</span> <span class="pl-k">-</span><span class="pl-c1">1</span>}
    },
    {
      $project<span class="pl-k">:</span>
      {
        _id<span class="pl-k">:</span> <span class="pl-c1">0</span>,
        Year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$_id<span class="pl-pds">"</span></span>,
        PostCode<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priciestPostCode<span class="pl-pds">"</span></span>,
        <span class="pl-c1">Location</span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$locationData.location<span class="pl-pds">"</span></span>
      }
    },
    {
      $out<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>hottestLocations<span class="pl-pds">"</span></span>
    }
  ])</pre>
</div>
<div class="highlight highlight-source-js">
<pre>db.hottestLocations.findOne()
{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> ObjectId(<span class="pl-s"><span class="pl-pds">"</span>5629108c96be45aba9cb0c98<span class="pl-pds">"</span></span>),
  <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>,
  <span class="pl-s"><span class="pl-pds">"</span>PostCode<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>SL6 9UD<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>Location<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    {
      <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
        <span class="pl-c1">51.558455</span>,
        <span class="pl-k">-</span><span class="pl-c1">0.756023</span>
      ]
    }
  ]
}</pre>
</div>
<p>In this example, geospatial operations are performed on the <code>location</code> from the <code>postcodes</code> collection and so a geospatial index should be added:</p>
<div class="highlight highlight-source-js">
<pre>db.postcodes.createIndex({location<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>2dsphere<span class="pl-pds">"</span></span>})</pre>
</div>
<p>A function is created that, given a location, will find the five nearest postcodes ‚Äì taking advantage of a <code>$geoNear</code> stage ‚Äì note that this must be the first stage in the pipeline:</p>
<div class="highlight highlight-source-js">
<pre><span class="pl-k">var</span> <span class="pl-en">findNeighbours</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">spot</span>, <span class="pl-smi">yearTag</span>) {
  <span class="pl-k">var</span> result <span class="pl-k">=</span> db.postcodes.aggregate([
      {
        $geoNear<span class="pl-k">:</span>
        {
          near<span class="pl-k">:</span> spot,
          distanceField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>distance<span class="pl-pds">"</span></span>,
          num<span class="pl-k">:</span> <span class="pl-c1">5</span>,
          spherical<span class="pl-k">:</span> <span class="pl-c1">true</span>
        }
      },
      {
        $group<span class="pl-k">:</span> {
          _id<span class="pl-k">:</span> yearTag,
          <span class="pl-s"><span class="pl-pds">"</span>neighbours<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
            $addToSet<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$postcode<span class="pl-pds">"</span></span>
          }
        }
      }
    ]);
  <span class="pl-k">return</span> result.result;
}</pre>
</div>
<p>Then, for each of the <code>hottestLocations</code> collection, that function is called to display and the contents of the returned cursor are displayed:</p>
<div class="highlight highlight-source-js">
<pre>db.hottestLocations.<span class="pl-c1">find</span>().forEach(<span class="pl-k">function</span>(<span class="pl-smi">myDoc</span>) {
  <span class="pl-k">var</span> myCursor <span class="pl-k">=</span> findNeighbours(myDoc.<span class="pl-c1">Location</span>[<span class="pl-c1">0</span>], myDoc.Year);
  myCursor.forEach(printjson);
})</pre>
</div>
<p>The result is a list of the 5 closest postcodes to the top selling home each year:</p>
<div class="highlight highlight-source-js">
<pre>{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1995</span>,
  <span class="pl-s"><span class="pl-pds">"</span>neighbours<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    <span class="pl-s"><span class="pl-pds">"</span>SL6 2NL<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 2JL<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 2NB<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 2JN<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 2NA<span class="pl-pds">"</span></span>
  ]
}

...

{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>,
  <span class="pl-s"><span class="pl-pds">"</span>neighbours<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
    <span class="pl-s"><span class="pl-pds">"</span>SL6 9XB<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 9XL<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 9UE<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 9UB<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>SL6 9UD<span class="pl-pds">"</span></span>
  ]
}</pre>
</div>
<h2>
<a id="user-content-bonus-query--for-those-choosing-a-school" class="anchor" href="#bonus-query--for-those-choosing-a-school" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bonus Query ‚Äì For Those Choosing a School</h2>
<p>There&#8217;s often a correlation between the house prices near a school and that school&#8217;s performance. So, if you were considering a specific school then it might make sense to check house prices in the area surrounding that school. </p>
<p>The following pipeline will find house price statistics, by year, for all postcodes within a 3 km radius of the school ‚Äì which is located at coordinates (51.5156725, -0.727387):</p>
<div class="highlight highlight-source-js">
<pre>db.postcodes.aggregate([
      {
        $geoNear<span class="pl-k">:</span>
        {
          near<span class="pl-k">:</span> 
          {
            <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Point<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>coordinates<span class="pl-pds">"</span></span><span class="pl-k">:</span> [
              <span class="pl-c1">51.5156725</span>,
              <span class="pl-k">-</span><span class="pl-c1">0.727387</span>
            ]},
          distanceField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>distance<span class="pl-pds">"</span></span>,
          num<span class="pl-k">:</span> <span class="pl-c1">10000</span>,
          maxDistance<span class="pl-k">:</span> <span class="pl-c1">3000</span>,
          spherical<span class="pl-k">:</span> <span class="pl-c1">true</span>
        }
      },
      {
        $lookup<span class="pl-k">:</span> {
          from<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>homeSales<span class="pl-pds">"</span></span>,
          localField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>postcode<span class="pl-pds">"</span></span>,
          foreignField<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>address.postcode<span class="pl-pds">"</span></span>,
          as<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>priceData<span class="pl-pds">"</span></span>
        }
      },
      {
        $unwind<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceData<span class="pl-pds">"</span></span>
      },

      {
        $group<span class="pl-k">:</span> 
        {
          _id<span class="pl-k">:</span> {$year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceData.date<span class="pl-pds">"</span></span>},
          highestPrice<span class="pl-k">:</span> {$max<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceData.amount<span class="pl-pds">"</span></span>},
          lowestPrice<span class="pl-k">:</span> {$min<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceData.amount<span class="pl-pds">"</span></span>},
          averagePrice<span class="pl-k">:</span> {$avg<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceData.amount<span class="pl-pds">"</span></span>},
          priceStdDev<span class="pl-k">:</span> {$stdDevPop<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceData.amount<span class="pl-pds">"</span></span>}
        }
      },
      {
        $project<span class="pl-k">:</span>
        {
          _id<span class="pl-k">:</span> <span class="pl-c1">0</span>,
          Year<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span>,
          highestPrice<span class="pl-k">:</span> <span class="pl-c1">1</span>,
          lowestPrice<span class="pl-k">:</span> <span class="pl-c1">1</span>,
          averagePrice<span class="pl-k">:</span> {$trunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$averagePrice<span class="pl-pds">"</span></span>},
          priceStdDev<span class="pl-k">:</span> {$trunc<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$priceStdDev<span class="pl-pds">"</span></span>}
        }
      },
      {
        $sort<span class="pl-k">:</span> 
        {
          <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-k">-</span><span class="pl-c1">1</span>
        }
      }
    ]);</pre>
</div>
<div class="highlight highlight-source-js">
<pre>{
  <span class="pl-s"><span class="pl-pds">"</span>highestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1350000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">125000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">410593</span>,
  <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">182358</span>,
  <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2015</span>
},
...
{
  <span class="pl-s"><span class="pl-pds">"</span>highestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">930000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>lowestPrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">12000</span>,
  <span class="pl-s"><span class="pl-pds">"</span>averagePrice<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">103455</span>,
  <span class="pl-s"><span class="pl-pds">"</span>priceStdDev<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">68615</span>,
  <span class="pl-s"><span class="pl-pds">"</span>Year<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1995</span>
}</pre>
</div>
<h2>
<a id="user-content-limitations" class="anchor" href="#limitations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Limitations</h2>
<p>As seen, it‚Äôs possible to build up sophisticated analytical queries using the enhanced aggregation features ‚Äì especially when pipelines are combined with a little application or scripting glue. </p>
<p>Some limitations that you may meet include:</p>
<ul>
<li>
<code>$geoNear</code> can only be used as the first stage in the pipeline</li>
<li>
<code>$lookup</code> only supports equality for the match and the equality has to be between a single key from each collection</li>
<li>The right-collection for <code>$lookup</code> cannot be sharded</li>
<li>The pipeline is linear; there are no forks and once data has been aggregated, the lost details can&#8217;t be reused later in the pipeline (this is why writing results to a new collection using <code>$out</code> can be helpful)</li>
<li>One can remove information at each stage but it&#8217;s impossible to add new raw data (other than through <code>$lookup</code>)</li>
<li>Indexes are only used for the beginning stages of the pipeline (and right tables in any subsequent <code>$lookup</code>)</li>
<li>
<code>$out</code> can only be used in the final stage of the pipeline</li>
</ul>
<h2>
<a id="user-content-when-to-use-full-data-visualization-solutions" class="anchor" href="#when-to-use-full-data-visualization-solutions" aria-hidden="true"><span class="octicon octicon-link"></span></a>When to Use Full Data Visualization Solutions</h2>
<p>A lot can be achieved directly in the database ‚Äì especially when augmented with a small amount of code. So when would it make sense to use a BI visualization tool such as Tableau. The capabilities will vary from product to product but some general considerations are given here:</p>
<ul>
<li>
<strong>Visualization</strong> ‚Äì displaying information in graphs and on maps (rather than in JSON result sets) makes it much simpler for the human mind to see patterns and draw conclusions from the data (see Figure 1 which is based on the same data set used earlier and graphically shows the highest home sale price by location and year)</li>
<li>
<strong>Multiple Data Sources</strong> ‚Äì combining data from multiple sources (data blending); for example from a MongoDB database and an Excel spreadsheet can greatly broaden the context of reports</li>
<li>
<strong>Interactivity</strong> ‚Äì visualization tools make it simple to create interactive queries/dashboards where business user can graphically tweak parameters to get precise results and test theories</li>
<li>
<strong>Skills</strong> ‚Äì performing all of the analytics directly in MongoDB requires knowledge of the MongoDB Query Language and possibly some basic coding skills. Using the visualization tools is analogous to using intermediate features in Microsoft Excel such as pivot tables and graphs and so it opens up the ability to analyze the data to a broader set of users in the organization</li>
<li>
<strong>Extra functions</strong> ‚Äì for example, the ability to add trend lines to a chart</li>
</ul>
<p><a href="https://camo.githubusercontent.com/c06051cc9b7415379160844df37fd39da4c75e38/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f5461626c6561755f4d6f6e676f44425f446174612e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/c06051cc9b7415379160844df37fd39da4c75e38/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f5461626c6561755f4d6f6e676f44425f446174612e706e67" alt="MongoDB Data Visualized in a Tableau Map" title="MongoDB Data Visualized in a Tableau Map" data-canonical-src="http://clusterdb.com/upload/Tableau_MongoDB_Data.png" style="max-width:100%;"></a><br>
<em>Figure 1: MongoDB Data Visualized in a Tableau Map</em></p>
<p>MongoDB 3.2 introduces the MongoDB Connector for BI which allows Business Intelligence tools such as Tableau to access data from MongoDB using SQL ‚Äì opening up a range of new options for performing analytics on live data.</p>
<h2>
<a id="user-content-next-steps" class="anchor" href="#next-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Next Steps</h2>
<p>To learn more about what&#8217;s coming up in MongoDB 3.2, register for the <a href="https://www.mongodb.com/webinar/whats-new-in-mongodb-3-2">What&#8217;s new in MongoDB 3.2 webinar</a> and review the <a href="https://docs.mongodb.org/manual/release-notes/3.2/">MongoDB 3.2 release notes</a>.</p>
<p>There&#8217;s a <a href="https://www.mongodb.com/presentations/webinar-joins-and-other-aggregation-enhancements-coming-in-mongodb-3-2" title="Webinar: Joins and Other Aggregation Enhancements Coming in MongoDB 3.2">webinar recording</a> explaining more about <code>$lookup</code> and the other aggregation features.</p>
<p>To get the best understanding of the new features then you should experiment with the software which is available in the MongoDB 3.2 (not for production) download ‚Äì to use the new <code>$lookup</code> aggregation theMongoDB Enterprise Advanced download should be used.</p>
<p>The reason MongoDB releases development releases is to give the community a chance to try out the new software ‚Äì and we hope that you&#8217;ll give us feedback, whether it be by joining the <a href="https://www.mongodb.com/blog/post/announcing-the-mongodb-3-2-bug-hunt">MongoDB 3.2 bug hunt</a> or commenting on this post.</p>

<p></p>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
					<div class="clear"></div>
									
		<br>
		<script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
   		<a href="http://twitter.com/share" class="twitter-share-button" data-url=".//mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2" data-via="wpbeginner" data-text="Joins and Other Aggregation Enhancements in MongoDB 3.2" data-related="syedbalkhi:Founder of WPBeginner" data-count="horizontal">Tweet</a>
		<br>
		<!-- <g:plusone size="medium" href=".//mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2"></g:plusone> -->
		<div class="g-plusone" data-annotation="inline" data-width="300"></div>
		<!-- Place this tag after the last +1 button tag. -->
		<script type="text/javascript">(function() {
    				var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    				po.src = 'https://apis.google.com/js/plusone.js';
    				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  			})();</script>
		<br>
		<script type="text/javascript" src="http://platform.linkedin.com/in.js"></script><script type="in/share" data-url=".//mongodb/joins-and-other-aggregation-enhancements-in-mongodb-3-2" data-counter="right"></script>
		<br>
		<iframe src="http://www.facebook.com/plugins/like.php?href=.%2F%2Fmongodb%2Fjoins-and-other-aggregation-enhancements-in-mongodb-3-2&amp;layout=standard&amp;show_faces=true&amp;width=450&amp;action=like&amp;colorscheme=light" scrolling="no" frameborder="0" allowtransparency="true" style="border:none; overflow:hidden; width:450px; height:60px;">
		</iframe>

<!-- ZXZX -->
				<div class="postinfo">Category: <a href="./../category/mongodb/index.html" rel="category tag">MongoDB</a> | 
Tags: <a href="./../tag/aggregation/index.html" rel="tag">aggregation</a>, <a href="./../tag/join/index.html" rel="tag">join</a>, <a href="./../tag/mongodb/index.html" rel="tag">mongodb</a>, <a href="./../tag/mongodb-3-2/index.html" rel="tag">MongoDB 3.2</a>
</div>

						<div id="post-4130" class="post-4130 post type-post status-publish format-standard hentry category-mongodb tag-document tag-document-validation tag-mongodb tag-mongodb-3-2">
				
				<div class="postmeta">	<div class="postmeta_links">
		<a href="./../author/andrew/index.html" title="Posts by andrew" rel="author">andrew</a> |
		<a href="./../mongodb/document-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents/index.html">November 6, 2015</a>
			</div>
	<div class="postcomments">
		<a href="./../mongodb/document-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents/index.html#respond">No comments</a>	</div>
	<div class="clear"></div>
</div>

				<h2 class="post-title"><a href="./../mongodb/document-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents/index.html" rel="bookmark">Document Validation &#8211; Adding Just the Right Amount of Control Over Your MongoDB Documents</a></h2>
				
				<div class="entry">
										<p></p>
<body>
<article class="markdown-body">
<p>This post looks at Document Validation, a new feature in MongoDB 3.2. It introduces the feature together with its benefits and then goes on to step through a tutorial on how to introduce validation to an existing, live MongoDB deployment. This material was orginally published on the <a href="https://www.mongodb.com/blog/post/document-validation-part-1-adding-just-the-right-amount-of-control-over-your-documents" title="Document Validation - Adding Just the Right Amount of Control Over Your MongoDB Documents">MongoDB blog</a>.</p>
<h3>
<a id="user-content-disclaimer" class="anchor" href="#disclaimer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Disclaimer</h3>
<p>MongoDB&#8217;s future product plans are for informational purposes only. MongoDB&#8217;s plans may change and you should not rely on them for delivery of a specific feature at a specific time.</p>
<h3>
<a id="user-content-introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h3>
<p>One of MongoDB‚Äôs primary attractions for developers is that it gives them the ability to start application development without first needing to define a formal schema. Operations teams appreciate the fact that they don&#8217;t need to perform a time-consuming schema upgrade operation every time the developers need to store a different attribute (as an example, <a href="https://www.mongodb.com/customers/weather-channel" title="The Weather Channel is now able to launch new features in hours whereas it used to take weeks">The Weather Channel is now able to launch new features in hours whereas it used to take weeks</a>. For business leaders, the application gets launched much faster, and new features can be rolled out more frequently. MongoDB powers agility.</p>
<p>Many projects reach a point where it&#8217;s necessary to enforce rules on what&#8217;s being stored in the database ‚Äì for example, that for any document in a particular collection, you can be assured that certain attributes are present. Reasons for this include:</p>
<ul>
<li>Different development teams working with the same data; each one needing to know what they can expect to find in a particular collection</li>
<li>Development teams working on different applications, spread over multiple sites means that a clear understanding of shared data is important</li>
<li>Development teams from different companies where misunderstandings about what data should be present can lead to issues</li>
</ul>
<p>As an example, an e-commerce website may centralize a product catalog feed from each of its vendors into a single collection. If one of the vendors alters the format of its product catalog, the global catalog search could fail.</p>
<p>This has resulted in developers building their own validation logic &#8211; either with the application code (possibly multiple times for different applications) or by adding middleware such as <a href="http://mongoosejs.com/" title="elegant mongodb object modeling for node.js">Mongoose</a>.</p>
<p>If the database doesn‚Äôt enforce rules about the data, development teams need to implement this logic in their applications. However, use of multiple development languages makes it hard to add a validation layer across multiple applications.</p>
<p>To address the challenges discussed above, while at the same time maintaining the benefits of a dynamic schema, MongoDB 3.2 introduces document validation.</p>
<h3>
<a id="user-content-validating-documents-in-mongodb-32" class="anchor" href="#validating-documents-in-mongodb-32" aria-hidden="true"><span class="octicon octicon-link"></span></a>Validating Documents in MongoDB 3.2</h3>
<p>Note that at the time of writing, MongoDB 3.2 is not yet released but this functionality can be tried out in <a href="https://docs.mongodb.org/master/release-notes/3.2/" title="MongoDB 3.2 Documentation">MongoDB 3.2</a> <strong>which is available for testing only, not production</strong>.</p>
<p>Document Validation provides significant flexibility to customize which parts of the documents are <strong>and are not</strong> validated for any collection. For any key it might be appropriate to check:</p>
<ul>
<li>That a key exists</li>
<li>If a key does exist, is it of the correct type</li>
<li>That the value is in a particular format (e.g., regular expressions can be used to check if the contents of the string matches a particular pattern)</li>
<li>That the value falls within a given range</li>
</ul>
<p>Further, it may be necessary to combine these checks ‚Äì for example that the document contains the user&#8217;s name and either their email address or phone number, and if the email address does exist, then it must be correctly formed.</p>
<p>Adding the validation checks to a collection is very intuitive to any developer or DBA familiar with MongoDB as it uses the same expression syntax as a <code>find</code> query to search the database. As an example, the following snippet adds validations to the <code>contacts</code> collection that validates:</p>
<ul>
<li>The year of birth is no later than 1994</li>
<li>The document contains a phone number and/or an email address </li>
<li>When present, the phone number and email addresses are strings</li>
</ul>
<div class="highlight highlight-source-js">
<pre>db.runCommand({
   collMod<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>contacts<span class="pl-pds">"</span></span>,
   validator<span class="pl-k">:</span> { 
      $and<span class="pl-k">:</span> [
        {year_of_birth<span class="pl-k">:</span> {$lte<span class="pl-k">:</span> <span class="pl-c1">1994</span>}},
        {$or<span class="pl-k">:</span> [ 
                  {phone<span class="pl-k">:</span> { $type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>string<span class="pl-pds">"</span></span>}}, 
                  {email<span class="pl-k">:</span> { $type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>string<span class="pl-pds">"</span></span>}}
              ]}]
    }})</pre>
</div>
<h3>
<a id="user-content-when-and-how-to-add-document-validation" class="anchor" href="#when-and-how-to-add-document-validation" aria-hidden="true"><span class="octicon octicon-link"></span></a>When and How to Add Document Validation</h3>
<p>Proponents of the waterfall development processes would assert that all of the validations should be added right at the start of the project ‚Äì certainly before going into production. This is possible, but in more agile approaches, the first version may deploy with no validations and future releases will add new data and checks. Fortunately, MongoDB 3.2 provides a great deal of flexibility in this area. </p>
<p>For existing data, we want to allow the application to continue to operate as we introduce validation into our collections. Therefore, we want to allow updates and simply log failed validations so we can take corrective measures separately if necessary, or take no action.</p>
<p>For new data, we want to ensure the data is valid and therefore return an error if the validation fails.</p>
<p>For any collection, developers or the DBA can choose to specify validation rules for each collection as well as indicating whether failed validations result in a hard error or just a warning ‚Äì Table 1 shows the available permutations.</p>
<p><a href="https://camo.githubusercontent.com/7a2ba719204606a07e202de4d1bee8972f5e7726/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f746162782e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/7a2ba719204606a07e202de4d1bee8972f5e7726/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f746162782e706e67" alt="Configuration options for controlling how document validations are applied to a collection" data-canonical-src="http://clusterdb.com/upload/tabx.png" style="max-width:100%;"></a></p>
<p><em>Table 1: Configuration Options for Document Validation</em></p>
<p>Figure 1 illustrates one possible timeline for how the application is developed.</p>
<p><a href="https://camo.githubusercontent.com/48cc829a4d7298a7bf6310c9bce926b2661630b3/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f496e74726f647563696e675f646f63756d656e745f76616c69646174696f6e732e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/48cc829a4d7298a7bf6310c9bce926b2661630b3/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f496e74726f647563696e675f646f63756d656e745f76616c69646174696f6e732e706e67" alt="Lifecycle for introducing document validation" data-canonical-src="http://clusterdb.com/upload/Introducing_document_validations.png" style="max-width:100%;"></a></p>
<p><em>Figure 1: Aligning document validation with application lifecycle</em></p>
<p>Of course, as applications evolve they require additional pieces of data and it will often make sense to add to the documentat validation rules to check that this data is always included. Figure 2 illustrates an example timeline of how this could be managed.</p>
<p><a href="https://camo.githubusercontent.com/58012ff5b68410c0b954c6d3db0a28bbb2bb8308/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f457874656e64696e675f646f63756d656e745f76616c69646174696f6e732e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/58012ff5b68410c0b954c6d3db0a28bbb2bb8308/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f457874656e64696e675f646f63756d656e745f76616c69646174696f6e732e706e67" alt="Introducing New Data Together with Validations" title="Introducing New Data Together with Validations" data-canonical-src="http://clusterdb.com/upload/Extending_document_validations.png" style="max-width:100%;"></a></p>
<p><em>Figure 2: Introducing New Data Together with Validations</em></p>
<h3>
<a id="user-content-coping-with-multiple-schema-versions" class="anchor" href="#coping-with-multiple-schema-versions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Coping with Multiple Schema Versions</h3>
<p>A tricky problem to solve with RDBMSs is the versioning of data models; with MongoDB it&#8217;s very straight-forward to set up validations that can cope with different versions of documents, with each version having a different set of checks applied. In the example validation checks below, the following logic is applied:</p>
<ul>
<li>If the document is unversioned (possibly dating to the time before validations were added), then no checks are applied</li>
<li>For version 1, the document is checked to make sure that the <code>name</code> key exists</li>
<li>For version 2 documents, the type of the <code>name</code> key is also validated to ensure that it is a string</li>
</ul>
<div class="highlight highlight-source-js">
<pre>db.runCommand({
   collMod<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>contacts<span class="pl-pds">"</span></span>,
   validator<span class="pl-k">:</span>
     {$or<span class="pl-k">:</span> [{version<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>$exists<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">false</span>}},
            {version<span class="pl-k">:</span> <span class="pl-c1">1</span>,
             $and<span class="pl-k">:</span> [{Name<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>$exists<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>}}]
            },
            {version<span class="pl-k">:</span> <span class="pl-c1">2</span>,
             $and<span class="pl-k">:</span> [{Name<span class="pl-k">:</span> {<span class="pl-s"><span class="pl-pds">"</span>$exists<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">true</span>, <span class="pl-s"><span class="pl-pds">"</span>$type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">2</span>}}]
            }
          ]
      } 
})</pre>
</div>
<p>In this way, multiple versions of documents can exist within the same collection, and the application can lazily up-version them over time. Note that the <code>version</code> attribute is user-defined.</p>
<h3>
<a id="user-content-document-validation-limitations-in-mongodb-32" class="anchor" href="#document-validation-limitations-in-mongodb-32" aria-hidden="true"><span class="octicon octicon-link"></span></a>Document Validation Limitations in MongoDB 3.2</h3>
<p>This is the first release of Document Validation and so it&#8217;s inevitable that there are still some things that would be great to add:</p>
<ul>
<li>The current error message is very generic and doesn&#8217;t pick out which part of your document failed validation (note that the validation rule for a collection may check several things across many attributes). <a href="https://jira.mongodb.org/browse/SERVER-20547">Jira ticket</a>
</li>
<li>The validation checks cannot compare one key&#8217;s value against another (whether in the same or different documents). For example <code>{salary: {$gte: startingSalary}}</code> is not possible. <a href="https://jira.mongodb.org/browse/SERVER-2702">Jira ticket</a>
</li>
<li>It is the application or DBA&#8217;s responsibility to bring legacy data into compliance with new rules (there are no audits or tools) &#8211; the tutorial in this post attempts to show how this can be done.</li>
</ul>
<h3>
<a id="user-content-where-mongodb-document-validation-excels-vs-rdbmss" class="anchor" href="#where-mongodb-document-validation-excels-vs-rdbmss" aria-hidden="true"><span class="octicon octicon-link"></span></a>Where MongoDB Document Validation Excels (vs. RDBMSs)</h3>
<p>In MongoDB, Document Validation is simple to set up. There is no need for stored procedures ‚Äì which for many types of validation would be required in an RDBMS ‚Äì and because the familiar MongoDB query language is used, there is no new syntax to learn.</p>
<p>The functionality is very flexible and it can enforce constraints on as little or as much of the schema as required. You get the best of both worlds ‚Äì a dynamic schema for rapidly changing, polymorphic data, with the option to enforce strict validation checks against specific attributes from the onset of your project, or much later on. If you initially have no validations defined, they can still be added later ‚Äì even once in production, across thousand of servers.</p>
<p>It is always a concern whether adding extra checks will impact the performance of the system; in our tests, document validation adds a negligible overhead.</p>
<h3>
<a id="user-content-so-is-all-data-validation-now-done-in-the-database" class="anchor" href="#so-is-all-data-validation-now-done-in-the-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>So, is all Data Validation Now Done in the Database?</h3>
<p>The answer is &#8216;probably not&#8217; ‚Äì either because there&#8217;s a limit to what can be done in the database or because there will always be a more appropriate place for some checks. Here are some areas to consider:</p>
<ul>
<li>For a good user-experience, checks should be made as high up the stack as is sensible. For example, the format of an entered email address should be first checked in the browser rather than waiting for the request to be processed and an attempt made to write it to the database.</li>
<li>Any validations which need to compare values between keys, other documents, or external information cannot currently be implemented within the database.</li>
<li>Many checks are best made within the application&#8217;s business logic ‚Äì for example &#8220;is this user allowed to use these services in their home country&#8221;; the checks in the database are primarily there to protect against coding errors.</li>
<li>If you need information on <strong>why</strong> the document failed validation then the application will need to check against each of the sub-rules within collection&#8217;s validation rule as the error message will not currently give this level of detail.</li>
</ul>
<h3>
<a id="user-content-tutorial" class="anchor" href="#tutorial" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tutorial</h3>
<p>The intent of this section is to step you through exactly how document validation can be introduced into an existing production deployment in such a way that there is no impact to your users. It covers:</p>
<ul>
<li>Setting up some test data (not needed for a real deployment)</li>
<li>Using MongoDB Compass and the <code>mongo</code> shell to reverse engineer the de facto data model and identify anomalies in the existing documents</li>
<li>Defining the appropriate document validation rules</li>
<li>Preventing new documents being added which don‚Äôt follow the new rules</li>
<li>Bring existing documents ‚Äúup to spec‚Äù against the new rules</li>
</ul>
<p>This section looks at taking an existing, deployed database which currently has no document validations defined. It steps through understanding what the current document structure looks like; deciding on what rules to add and then rolling out those new rules.</p>
<p>As a pre-step add some data to the database (obviously, this isn&#8217;t needed if working with your real deployment).</p>
<div class="highlight highlight-source-js">
<pre>use clusterdb;
db.dropDatabase();
use clusterdb();
db.inventory.insert({ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">"</span>sku<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>abc<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>product 1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>instock<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">120</span> });
db.inventory.insert({ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">2</span>, <span class="pl-s"><span class="pl-pds">"</span>sku<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>def<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>product 2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>instock<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">80</span> });
db.inventory.insert({ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">3</span>, <span class="pl-s"><span class="pl-pds">"</span>sku<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>ijk<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>product 3<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>instock<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">60</span> });
db.inventory.insert({ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">4</span>, <span class="pl-s"><span class="pl-pds">"</span>sku<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>jkl<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>product 4<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>instock<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">70</span> });
db.inventory.insert({ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">5</span>, <span class="pl-s"><span class="pl-pds">"</span>sku<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">null</span>, 
    <span class="pl-s"><span class="pl-pds">"</span>description<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Incomplete<span class="pl-pds">"</span></span> });
db.inventory.insert({ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">6</span> });

<span class="pl-k">for</span> (i<span class="pl-k">=</span><span class="pl-c1">1000</span>; i<span class="pl-k">&lt;</span><span class="pl-c1">2000</span>; i<span class="pl-k">++</span>) {
  db.orders.insert({
    _id<span class="pl-k">:</span> i,
    item<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>abc<span class="pl-pds">"</span></span>, 
    price<span class="pl-k">:</span> i <span class="pl-k">%</span> <span class="pl-c1">50</span>,
    quantity<span class="pl-k">:</span> i <span class="pl-k">%</span> <span class="pl-c1">5</span>
  });
};

<span class="pl-k">for</span> (i<span class="pl-k">=</span><span class="pl-c1">2000</span>; i<span class="pl-k">&lt;</span><span class="pl-c1">3000</span>; i<span class="pl-k">++</span>) {
  db.orders.insert({
    _id<span class="pl-k">:</span> i,
    item<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>jkl<span class="pl-pds">"</span></span>, 
    price<span class="pl-k">:</span> i <span class="pl-k">%</span> <span class="pl-c1">30</span>,
    quantity<span class="pl-k">:</span> <span class="pl-c1">Math</span>.<span class="pl-c1">floor</span>(<span class="pl-c1">10</span> <span class="pl-k">*</span> <span class="pl-c1">Math</span>.<span class="pl-c1">random</span>()) <span class="pl-k">+</span> <span class="pl-c1">1</span>
  });
};

<span class="pl-k">for</span> (i<span class="pl-k">=</span><span class="pl-c1">3000</span>; i<span class="pl-k">&lt;</span><span class="pl-c1">3200</span>; i<span class="pl-k">++</span>) {
  db.orders.insert({
    _id<span class="pl-k">:</span> i,
    price<span class="pl-k">:</span> i <span class="pl-k">%</span> <span class="pl-c1">30</span>,
    quantity<span class="pl-k">:</span> <span class="pl-c1">Math</span>.<span class="pl-c1">floor</span>(<span class="pl-c1">10</span> <span class="pl-k">*</span> <span class="pl-c1">Math</span>.<span class="pl-c1">random</span>()) <span class="pl-k">+</span> <span class="pl-c1">1</span>
  });
};

<span class="pl-k">for</span> (i<span class="pl-k">=</span><span class="pl-c1">3200</span>; i<span class="pl-k">&lt;</span><span class="pl-c1">3500</span>; i<span class="pl-k">++</span>) {
  db.orders.insert({
    _id<span class="pl-k">:</span> i,
    item<span class="pl-k">:</span> <span class="pl-c1">null</span>,
    price<span class="pl-k">:</span> i <span class="pl-k">%</span> <span class="pl-c1">30</span>,
    quantity<span class="pl-k">:</span> <span class="pl-c1">Math</span>.<span class="pl-c1">floor</span>(<span class="pl-c1">10</span> <span class="pl-k">*</span> <span class="pl-c1">Math</span>.<span class="pl-c1">random</span>()) <span class="pl-k">+</span> <span class="pl-c1">1</span>
  });
};

<span class="pl-k">for</span> (i<span class="pl-k">=</span><span class="pl-c1">3500</span>; i<span class="pl-k">&lt;</span><span class="pl-c1">4000</span>; i<span class="pl-k">++</span>) {
  db.orders.insert({
    _id<span class="pl-k">:</span> i,
    item<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>abc<span class="pl-pds">"</span></span>,
    price<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>free<span class="pl-pds">"</span></span>,
    quantity<span class="pl-k">:</span> <span class="pl-c1">Math</span>.<span class="pl-c1">floor</span>(<span class="pl-c1">10</span> <span class="pl-k">*</span> <span class="pl-c1">Math</span>.<span class="pl-c1">random</span>()) <span class="pl-k">+</span> <span class="pl-c1">1</span>
  });
};

<span class="pl-k">for</span> (i<span class="pl-k">=</span><span class="pl-c1">4000</span>; i<span class="pl-k">&lt;</span><span class="pl-c1">4250</span>; i<span class="pl-k">++</span>) {
  db.orders.insert({
    _id<span class="pl-k">:</span> i,
    item<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>abc<span class="pl-pds">"</span></span>,
    price<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>if you have to ask....<span class="pl-pds">"</span></span>,
    quantity<span class="pl-k">:</span> <span class="pl-c1">Math</span>.<span class="pl-c1">floor</span>(<span class="pl-c1">10</span> <span class="pl-k">*</span> <span class="pl-c1">Math</span>.<span class="pl-c1">random</span>()) <span class="pl-k">+</span> <span class="pl-c1">1</span>
  });
};</pre>
</div>
<p>The easiest way to start understanding the de facto schema for your database is to use MongoDB Compass. Simply connect Compass to your <code>mongod</code> (or <code>mongos</code> if you&#8217;re using sharding) and select the database/collection you&#8217;d like to look into. To see MongoDB Compass in action ‚Äì view this <a href="https://www.google.com/url?q=https://youtu.be/3w9HVFh1hRs">demo video</a>.</p>
<p>As shown in Figure 3, there are <strong>typically</strong> four keys in each document from the <code>clusterdb.orders</code> table:</p>
<ul>
<li>
<code>_id</code> is  always present and is a number</li>
<li>
<code>item</code> is normally present and is a string (either &#8220;abc&#8221; or &#8220;jkl&#8221;) but is occasionally <code>null</code> or missing altogether (undefined)</li>
<li>
<code>price</code> is always present and is in most cases a number (the histogram shows how the values are distributed between 0 and 49) but in some cases it&#8217;s a string</li>
<li>
<code>quantity</code> is always present and is a number</li>
</ul>
<p><a href="https://camo.githubusercontent.com/c6be166af57c3e05bd9178641b3b44e2b09303d1/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d70617373312e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/c6be166af57c3e05bd9178641b3b44e2b09303d1/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d70617373312e706e67" alt="Viewing the Document Schema using MongoDB Compass" title="Viewing the Document Schema using MongoDB Compass" data-canonical-src="http://clusterdb.com/upload/Compass1.png" style="max-width:100%;"></a></p>
<p><em>Figure 3: Viewing the Document Schema using MongoDB Compass</em></p>
<p>For this tutorial, we&#8217;ll focus on the <code>price</code>. By clicking on the <code>string</code> label, Compass will show us more information about the string content for <code>price</code> &#8211; this is shown in Figure 4.</p>
<p><a href="https://camo.githubusercontent.com/e9c905f6f8c7b0a2e50ae9cd8116072c0d1b9daf/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d70617373322e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/e9c905f6f8c7b0a2e50ae9cd8116072c0d1b9daf/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d70617373322e706e67" alt="Drilling Down into string Values" title="Drilling Down into string Values" data-canonical-src="http://clusterdb.com/upload/Compass2.png" style="max-width:100%;"></a></p>
<p><em>Figure 4: Drilling Down into string Values</em></p>
<p>Compass shows us that:</p>
<ul>
<li>For those instances of <code>price</code> which are strings, the common values are &#8220;free&#8221; and &#8220;if you have to ask&#8230;.&#8221;. </li>
<li>If you click on one of those values, a query expression is formed and clicking &#8220;Apply&#8221; runs that query and now Compass will show you information only for that subset of documents. For example, where <code>price == "if you have to ask...."</code> (see Figure 5). </li>
<li>By selecting multiple attributes, you can build up fairly complex queries.</li>
<li>The query you build visually is printed at the top so you can easily copy/paste into other contexts like the shell.</li>
</ul>
<p><a href="https://camo.githubusercontent.com/65ae683d19bb485b640b21590bbca8de71bcb208/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d70617373332e706e67" target="_blank"><img decoding="async" src="https://camo.githubusercontent.com/65ae683d19bb485b640b21590bbca8de71bcb208/687474703a2f2f636c757374657264622e636f6d2f75706c6f61642f436f6d70617373332e706e67" alt="Formulating Search Expressions with MongoDB Compass" title="Formulating Search Expressions with MongoDB Compass" data-canonical-src="http://clusterdb.com/upload/Compass3.png" style="max-width:100%;"></a></p>
<p><em>Figure 5: Formulating Search Expressions with MongoDB Compass</em></p>
<p>If applications are to work with the <code>price</code> from these documents then it would be simpler it it was always set to a numerical value, and so this is something that should be fixed.</p>
<p>Before cleaning up the existing documents, the application should be updated to ensure numerical values are stored in the price field. We can do this by adding a new validation rule to the collection. We want this rule to:</p>
<ul>
<li>Allow changes to existing invalid documents</li>
<li>Prevent inserts of new documents which violate validation rules</li>
<li>Set up a <strong>very</strong> simple document validation rule that checks that <code>price</code> exists and contains a <code>double</code> ‚Äì see the <a href="http://docs.mongodb.org/master/reference/bson-types/" title="MongoDB BSON types">enumeration of MongoDB BSON types</a> </li>
</ul>
<p>These steps should be run from the <code>mongo</code> shell:</p>
<div class="highlight highlight-source-js">
<pre>db.orders.runCommand(<span class="pl-s"><span class="pl-pds">"</span>collMod<span class="pl-pds">"</span></span>, 
                   {validationLevel<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>moderate<span class="pl-pds">"</span></span>, 
                    validationAction<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>error<span class="pl-pds">"</span></span>});

db.runCommand({collMod<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>orders<span class="pl-pds">"</span></span>, 
               validator<span class="pl-k">:</span> {
                  price<span class="pl-k">:</span> {$exists<span class="pl-k">:</span> <span class="pl-c1">true</span>},
                  price<span class="pl-k">:</span> {$type<span class="pl-k">:</span> <span class="pl-c1">1</span>}
                }
              });</pre>
</div>
<p>The validation rules for this collection can now be checked:</p>
<div class="highlight highlight-source-js">
<pre>db.getCollectionInfos({name<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">"</span>orders<span class="pl-pds">"</span></span>})
[
  {
    <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>orders<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>options<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
      <span class="pl-s"><span class="pl-pds">"</span>validator<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
        <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
          <span class="pl-s"><span class="pl-pds">"</span>$type<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1</span>
        }
      },
      <span class="pl-s"><span class="pl-pds">"</span>validationLevel<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>moderate<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>validationAction<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>error<span class="pl-pds">"</span></span>
    }
  }
]</pre>
</div>
<p>Now that this has been set up, it&#8217;s possible to check that we can&#8217;t add a new document that breaks the rule:</p>
<div class="highlight highlight-source-js">
<pre>db.orders.insert({
    <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">6666</span>, 
    <span class="pl-s"><span class="pl-pds">"</span>item<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>jkl<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>rogue<span class="pl-pds">"</span></span>,
    <span class="pl-s"><span class="pl-pds">"</span>quantity<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1</span> });

Document failed validation
WriteResult({
  <span class="pl-s"><span class="pl-pds">"</span>nInserted<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">0</span>,
  <span class="pl-s"><span class="pl-pds">"</span>writeError<span class="pl-pds">"</span></span><span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">121</span>,
    <span class="pl-s"><span class="pl-pds">"</span>errmsg<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Document failed validation<span class="pl-pds">"</span></span>
  }
})</pre>
</div>
<p>But it&#8217;s OK to modify an existing document that does break the rule:</p>
<div class="highlight highlight-source-js">
<pre>db.orders.findOne({price<span class="pl-k">:</span> {$type<span class="pl-k">:</span> <span class="pl-c1">2</span>}});

{
  <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">3500</span>,
  <span class="pl-s"><span class="pl-pds">"</span>item<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>abc<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>price<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>free<span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>quantity<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">5</span>
}

<span class="pl-k">&gt;</span> db.orders.update(
    {_id<span class="pl-k">:</span> <span class="pl-c1">3500</span>},
    {$set<span class="pl-k">:</span> {quantity<span class="pl-k">:</span> <span class="pl-c1">12</span>}});

Updated <span class="pl-c1">1</span> existing record(s) <span class="pl-k">in</span> 5ms
WriteResult({
  <span class="pl-s"><span class="pl-pds">"</span>nMatched<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1</span>,
  <span class="pl-s"><span class="pl-pds">"</span>nUpserted<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">0</span>,
  <span class="pl-s"><span class="pl-pds">"</span>nModified<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-c1">1</span>
})</pre>
</div>
<p>Now that the application is no longer able to store new documents that break the new rule, it&#8217;s time to clean up the &#8220;legacy&#8221; documents. At this point, it&#8217;s important to point out that Compass works on a random sample of the documents in a collection (this is what allows it to be so quick). To make sure that we&#8217;re fixing <strong>all</strong> of the documents, we check from the <code>mongo</code> shell. As the following commands could consume significant resources, it may make sense to run them on a secondary):</p>
<div class="highlight highlight-source-js">
<pre>secondary<span class="pl-k">&gt;</span> db.orders.aggregate([
    {$match<span class="pl-k">:</span> {
      price<span class="pl-k">:</span> {$type<span class="pl-k">:</span> <span class="pl-c1">2</span>}}},
    {$group<span class="pl-k">:</span> {
      _id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>$price<span class="pl-pds">"</span></span>, 
      count<span class="pl-k">:</span> {$sum<span class="pl-k">:</span><span class="pl-c1">1</span>}}}
  ])

{ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>if you have to ask....<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>count<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">250</span> }
{ <span class="pl-s"><span class="pl-pds">"</span>_id<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>free<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>count<span class="pl-pds">"</span></span> <span class="pl-k">:</span> <span class="pl-c1">500</span> }</pre>
</div>
<p>The number of exceptions isn&#8217;t too high and so it is safe to go ahead and fix up the data without consuming too many resources:</p>
<div class="highlight highlight-source-js">
<pre>db.orders.update(
    {price<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">"</span>free<span class="pl-pds">"</span></span>},
    {$set<span class="pl-k">:</span> {price<span class="pl-k">:</span> <span class="pl-c1">0</span>}},
    {multi<span class="pl-k">:</span> <span class="pl-c1">true</span>});

db.orders.update(
    {price<span class="pl-k">:</span><span class="pl-s"><span class="pl-pds">"</span>if you have to ask....<span class="pl-pds">"</span></span>},
    {$set<span class="pl-k">:</span> {price<span class="pl-k">:</span> <span class="pl-c1">1000000</span>}},
    {multi<span class="pl-k">:</span> <span class="pl-c1">true</span>});</pre>
</div>
<p>At this point it&#8217;s now safe to enter the strict mode where any inserts or updates will cause an error if the document being stored doesn&#8217;t follow the rules:</p>
<div class="highlight highlight-source-js">
<pre>db.orders.runCommand(<span class="pl-s"><span class="pl-pds">"</span>collMod<span class="pl-pds">"</span></span>, 
                   {validationLevel<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>strict<span class="pl-pds">"</span></span>, 
                    validationAction<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>error<span class="pl-pds">"</span></span>});</pre>
</div>
<h3>
<a id="user-content-next-steps" class="anchor" href="#next-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Next Steps</h3>
<p>Hopefully this has given you a sense for what the Document Validation functionality offers and started you thinking about how it could be applied to your application and database. I&#8217;d encourage you to read up more on the topic and these are some great resources:</p>
<ul>
<li><a href="https://www.mongodb.com/presentations/webinar-document-validation-in-mongodb-3-2" title="Webinar: Document Validation in MongoDB 3.2">Webinar: Document Validation in MongoDB 3.2</a></li>
<li><a href="https://docs.mongodb.org/master/release-notes/3.2/#document-validation" title="MongoDB 3.2 documentation for Document Validation">MongoDB 3.2 documentation for Document Validation</a></li>
<li>The best way to really get a feel for the functionality is to try it out for yourself:<a href="https://www.mongodb.org/downloads#development" title="Download MongoDB 3.2">Download MongoDB 3.2</a>
</li>
<li>Feedback is welcomed and we‚Äôd encourage you to join the <a href="https://www.mongodb.com/blog/post/announcing-the-mongodb-3-2-bug-hunt">MongoDB 3.2 bug hunt</a>
</li>
<li>
<a href="http://www.eliothorowitz.com/blog/2015/09/11/document-validation-and-what-dynamic-schema-means/" title="Document Validation and What Dynamic Schema Means">Document Validation and What Dynamic Schema Means</a> ‚Äì Eliot Horowitz. This blog post adds context to why this functionality is being introduced now.</li>
<li>
<a href="https://www.mongodb.com/presentations/data-management-3-bulletproof-data-management" title="Bulletproof Data Management">Bulletproof Data Management</a> ‚Äì Buzz Moschetti. Great presentation on how to look after your data &#8211; including in earlier versions of MongoDB.</li>
</ul>
</article>
<p></p>
</body>
</div>
</div>
</html><html>
<div class="clear"></div>
									
		<br>
		<script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
   		<a href="http://twitter.com/share" class="twitter-share-button" data-url=".//mongodb/document-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents" data-via="wpbeginner" data-text="Document Validation &#8211; Adding Just the Right Amount of Control Over Your MongoDB Documents" data-related="syedbalkhi:Founder of WPBeginner" data-count="horizontal">Tweet</a>
		<br>
		<!-- <g:plusone size="medium" href=".//mongodb/document-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents"></g:plusone> -->
		<div class="g-plusone" data-annotation="inline" data-width="300"></div>
		<!-- Place this tag after the last +1 button tag. -->
		<script type="text/javascript">
  			(function() {
    				var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    				po.src = 'https://apis.google.com/js/plusone.js';
    				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  			})();
		</script>
		<br>
		<script type="text/javascript" src="http://platform.linkedin.com/in.js"></script><script type="in/share" data-url=".//mongodb/document-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents" data-counter="right"></script>
		<br>
		<iframe src="http://www.facebook.com/plugins/like.php?href=.%2F%2Fmongodb%2Fdocument-validation-adding-just-the-right-amount-of-control-over-your-mongodb-documents&amp;layout=standard&amp;show_faces=true&amp;width=450&amp;action=like&amp;colorscheme=light" scrolling="no" frameborder="0" allowtransparency="true" style="border:none; overflow:hidden; width:450px; height:60px;">
		</iframe>

<!-- ZXZX -->
				<div class="postinfo">Category: <a href=".//category/mongodb" rel="category tag">MongoDB</a> | 
Tags: <a href=".//tag/document" rel="tag">document</a>, <a href=".//tag/document-validation" rel="tag">Document Validation</a>, <a href=".//tag/mongodb" rel="tag">mongodb</a>, <a href=".//tag/mongodb-3-2" rel="tag">MongoDB 3.2</a>
</div>

			      
							<div class="more_posts">
					<span class="post_links"> &nbsp; </span>
				</div>
						

					
	
		
		
<div id="sidebar">
	<ul>

<li id="search-2" class="widget widget_search"><form role="search" method="get" id="searchform" class="searchform" action=".//">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s">
					<input type="submit" id="searchsubmit" value="Search">
				</div>
			</form></li>

		<li id="recent-posts-2" class="widget widget_recent_entries">
		<h2 class="widgettitle">Recent Posts</h2>

		<ul>
											<li>
					<a href=".//mongodb/building-a-collaborative-ios-minesweeper-game-with-realm">Building a collaborative iOS Minesweeper game with Realm</a>
									</li>
											<li>
					<a href=".//mongodb/using-realm-flexible-sync-in-your-app-an-ios-tutorial">Using Realm Flexible Sync in Your App‚Äîan iOS Tutorial</a>
									</li>
											<li>
					<a href=".//mongodb/realm-swift-type-projections">Realm-Swift Type Projections</a>
									</li>
											<li>
					<a href=".//mongodb/introducing-flexible-sync-preview-the-next-iteration-of-realm-sync">Introducing Flexible Sync (Preview) ‚Äì The Next Iteration of Realm Sync</a>
									</li>
											<li>
					<a href=".//mongodb/goodbye-nspredicate-hello-realm-swift-query-api">Goodbye NSPredicate, hello Realm Swift Query API</a>
									</li>
					</ul>

		</li>
<li id="text-2" class="widget widget_text">			<div class="textwidget">
<script type="text/javascript"><!--
google_ad_client = "ca-pub-5257306915232759";
/* Clusterdb-home */
google_ad_slot = "1624229680";
google_ad_width = 200;
google_ad_height =600;
//-->
</script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
		</li>
<li id="recent-comments-2" class="widget widget_recent_comments">
<h2 class="widgettitle">Recent Comments</h2>
<ul id="recentcomments">
<li class="recentcomments">
<span class="comment-author-link"><a href="http://mikael.ronstrom@blogspot.com" class="url" rel="ugc external nofollow">Mikael Ronstr√∂m</a></span> on <a href=".//mysql-cluster/mysql-cluster-running-on-raspberry-pi#comment-787242">MySQL Cluster running on Raspberry Pi</a>
</li>
<li class="recentcomments">
<span class="comment-author-link">andrew</span> on <a href=".//mysql-cluster/setting-up-mysql-asynchronous-replication-for-high-availability#comment-668717">Setting up MySQL Asynchronous Replication for High Availability</a>
</li>
<li class="recentcomments">
<span class="comment-author-link"><a href="http://www.suksesonline.com" class="url" rel="ugc external nofollow">Betty</a></span> on <a href=".//mysql-cluster/setting-up-mysql-asynchronous-replication-for-high-availability#comment-668713">Setting up MySQL Asynchronous Replication for High Availability</a>
</li>
<li class="recentcomments">
<span class="comment-author-link">Sai Krishnan</span> on <a href=".//mysql-cluster/get-mysql-replication-up-and-running-in-5-minutes#comment-661143">Get MySQL Replication up and running in 5 minutes</a>
</li>
<li class="recentcomments">
<span class="comment-author-link">Nayan</span> on <a href=".//mysql-cluster/get-mysql-replication-up-and-running-in-5-minutes#comment-660628">Get MySQL Replication up and running in 5 minutes</a>
</li>
</ul>
</li>
<li id="categories-2" class="widget widget_categories">
<h2 class="widgettitle">Categories</h2>

			<ul>
					<li class="cat-item cat-item-2">
<a href=".//category/me">Me</a>
</li>
	<li class="cat-item cat-item-146">
<a href=".//category/mongodb">MongoDB</a>
</li>
	<li class="cat-item cat-item-3">
<a href=".//category/mysql">MySQL</a>
</li>
	<li class="cat-item cat-item-4">
<a href=".//category/mysql-cluster">MySQL Cluster</a>
</li>
	<li class="cat-item cat-item-131">
<a href=".//category/mysql-fabric">MySQL Fabric</a>
</li>
	<li class="cat-item cat-item-5">
<a href=".//category/mysql-replication">MySQL Replication</a>
</li>
	<li class="cat-item cat-item-214">
<a href=".//category/mongodb/realm">Realm</a>
</li>
	<li class="cat-item cat-item-1">
<a href=".//category/uncategorized">Uncategorized</a>
</li>
			</ul>

			</li>
<li id="tag_cloud-2" class="widget widget_tag_cloud">
<h2 class="widgettitle">Tags</h2>
<div class="tagcloud">
<a href=".//tag/7-4" class="tag-cloud-link tag-link-137 tag-link-position-1" style="font-size: 9.0632911392405pt;" aria-label="7.4 (7 items)">7.4</a>
<a href=".//tag/apache-kafka" class="tag-cloud-link tag-link-169 tag-link-position-2" style="font-size: 8.620253164557pt;" aria-label="Apache Kafka (6 items)">Apache Kafka</a>
<a href=".//tag/cluster" class="tag-cloud-link tag-link-18 tag-link-position-3" style="font-size: 8.620253164557pt;" aria-label="Cluster (6 items)">Cluster</a>
<a href=".//tag/ha" class="tag-cloud-link tag-link-41 tag-link-position-4" style="font-size: 15.354430379747pt;" aria-label="HA (40 items)">HA</a>
<a href=".//tag/high-availability" class="tag-cloud-link tag-link-43 tag-link-position-5" style="font-size: 15.26582278481pt;" aria-label="High Availability (39 items)">High Availability</a>
<a href=".//tag/ios" class="tag-cloud-link tag-link-215 tag-link-position-6" style="font-size: 10.658227848101pt;" aria-label="ios (11 items)">ios</a>
<a href=".//tag/java" class="tag-cloud-link tag-link-47 tag-link-position-7" style="font-size: 8.620253164557pt;" aria-label="Java (6 items)">Java</a>
<a href=".//tag/javascript" class="tag-cloud-link tag-link-48 tag-link-position-8" style="font-size: 10.303797468354pt;" aria-label="javascript (10 items)">javascript</a>
<a href=".//tag/mcm" class="tag-cloud-link tag-link-56 tag-link-position-9" style="font-size: 8pt;" aria-label="MCM (5 items)">MCM</a>
<a href=".//tag/mean" class="tag-cloud-link tag-link-186 tag-link-position-10" style="font-size: 8pt;" aria-label="MEAN (5 items)">MEAN</a>
<a href=".//tag/memcached" class="tag-cloud-link tag-link-57 tag-link-position-11" style="font-size: 8pt;" aria-label="Memcached (5 items)">Memcached</a>
<a href=".//tag/mobile" class="tag-cloud-link tag-link-211 tag-link-position-12" style="font-size: 8pt;" aria-label="mobile (5 items)">mobile</a>
<a href=".//tag/mongodb" class="tag-cloud-link tag-link-150 tag-link-position-13" style="font-size: 16.417721518987pt;" aria-label="mongodb (53 items)">mongodb</a>
<a href=".//tag/mongodb-3-2" class="tag-cloud-link tag-link-153 tag-link-position-14" style="font-size: 8pt;" aria-label="MongoDB 3.2 (5 items)">MongoDB 3.2</a>
<a href=".//tag/mongodb-atlas" class="tag-cloud-link tag-link-163 tag-link-position-15" style="font-size: 9.0632911392405pt;" aria-label="MongoDB Atlas (7 items)">MongoDB Atlas</a>
<a href=".//tag/mongodb-mobile" class="tag-cloud-link tag-link-212 tag-link-position-16" style="font-size: 8pt;" aria-label="MongoDB Mobile (5 items)">MongoDB Mobile</a>
<a href=".//tag/mongodb-stitch" class="tag-cloud-link tag-link-204 tag-link-position-17" style="font-size: 12.253164556962pt;" aria-label="MongoDB Stitch (17 items)">MongoDB Stitch</a>
<a href=".//tag/mysql" class="tag-cloud-link tag-link-147 tag-link-position-18" style="font-size: 22pt;" aria-label="MySQL (229 items)">MySQL</a>
<a href=".//tag/mysql-5-6" class="tag-cloud-link tag-link-64 tag-link-position-19" style="font-size: 10.924050632911pt;" aria-label="MySQL 5.6 (12 items)">MySQL 5.6</a>
<a href=".//tag/mysql-cluster" class="tag-cloud-link tag-link-148 tag-link-position-20" style="font-size: 21.46835443038pt;" aria-label="MySQL Cluster (198 items)">MySQL Cluster</a>
<a href=".//tag/mysql-cluster-70" class="tag-cloud-link tag-link-69 tag-link-position-21" style="font-size: 13.936708860759pt;" aria-label="MySQL Cluster 7.0 (27 items)">MySQL Cluster 7.0</a>
<a href=".//tag/mysql-cluster-7-1" class="tag-cloud-link tag-link-70 tag-link-position-22" style="font-size: 15.177215189873pt;" aria-label="MySQL Cluster 7.1 (38 items)">MySQL Cluster 7.1</a>
<a href=".//tag/mysql-cluster-7-2" class="tag-cloud-link tag-link-71 tag-link-position-23" style="font-size: 14.556962025316pt;" aria-label="MySQL Cluster 7.2 (32 items)">MySQL Cluster 7.2</a>
<a href=".//tag/mysql-cluster-7-3" class="tag-cloud-link tag-link-72 tag-link-position-24" style="font-size: 12.253164556962pt;" aria-label="MySQL Cluster 7.3 (17 items)">MySQL Cluster 7.3</a>
<a href=".//tag/mysql-cluster-7-4" class="tag-cloud-link tag-link-134 tag-link-position-25" style="font-size: 11.278481012658pt;" aria-label="MySQL Cluster 7.4 (13 items)">MySQL Cluster 7.4</a>
<a href=".//tag/mysql-cluster-cge" class="tag-cloud-link tag-link-73 tag-link-position-26" style="font-size: 17.569620253165pt;" aria-label="MySQL Cluster CGE (72 items)">MySQL Cluster CGE</a>
<a href=".//tag/mysql-cluster-manager" class="tag-cloud-link tag-link-74 tag-link-position-27" style="font-size: 12.607594936709pt;" aria-label="MySQL Cluster Manager (19 items)">MySQL Cluster Manager</a>
<a href=".//tag/mysql-enterprise-monitor" class="tag-cloud-link tag-link-76 tag-link-position-28" style="font-size: 9.0632911392405pt;" aria-label="MySQL Enterprise Monitor (7 items)">MySQL Enterprise Monitor</a>
<a href=".//tag/mysql-fabric-2" class="tag-cloud-link tag-link-132 tag-link-position-29" style="font-size: 9.0632911392405pt;" aria-label="mysql fabric (7 items)">mysql fabric</a>
<a href=".//tag/mysql-replication" class="tag-cloud-link tag-link-149 tag-link-position-30" style="font-size: 15.354430379747pt;" aria-label="MySQL Replication (40 items)">MySQL Replication</a>
<a href=".//tag/mysql-utilities" class="tag-cloud-link tag-link-78 tag-link-position-31" style="font-size: 8pt;" aria-label="MySQL Utilities (5 items)">MySQL Utilities</a>
<a href=".//tag/ndb-api" class="tag-cloud-link tag-link-80 tag-link-position-32" style="font-size: 10.303797468354pt;" aria-label="NDB API (10 items)">NDB API</a>
<a href=".//tag/node-js" class="tag-cloud-link tag-link-83 tag-link-position-33" style="font-size: 10.303797468354pt;" aria-label="node.js (10 items)">node.js</a>
<a href=".//tag/nosql" class="tag-cloud-link tag-link-84 tag-link-position-34" style="font-size: 12.784810126582pt;" aria-label="NoSQL (20 items)">NoSQL</a>
<a href=".//tag/performance" class="tag-cloud-link tag-link-97 tag-link-position-35" style="font-size: 9.9493670886076pt;" aria-label="Performance (9 items)">Performance</a>
<a href=".//tag/realm" class="tag-cloud-link tag-link-213 tag-link-position-36" style="font-size: 11.721518987342pt;" aria-label="Realm (15 items)">Realm</a>
<a href=".//tag/replication" class="tag-cloud-link tag-link-104 tag-link-position-37" style="font-size: 10.924050632911pt;" aria-label="Replication (12 items)">Replication</a>
<a href=".//tag/secondary" class="tag-cloud-link tag-link-138 tag-link-position-38" style="font-size: 11.278481012658pt;" aria-label="secondary (13 items)">secondary</a>
<a href=".//tag/serverless" class="tag-cloud-link tag-link-208 tag-link-position-39" style="font-size: 8.620253164557pt;" aria-label="serverless (6 items)">serverless</a>
<a href=".//tag/sharding" class="tag-cloud-link tag-link-129 tag-link-position-40" style="font-size: 8pt;" aria-label="sharding (5 items)">sharding</a>
<a href=".//tag/swift" class="tag-cloud-link tag-link-216 tag-link-position-41" style="font-size: 10.303797468354pt;" aria-label="Swift (10 items)">Swift</a>
<a href=".//tag/swiftui" class="tag-cloud-link tag-link-217 tag-link-position-42" style="font-size: 10.303797468354pt;" aria-label="SwiftUI (10 items)">SwiftUI</a>
<a href=".//tag/webcast" class="tag-cloud-link tag-link-124 tag-link-position-43" style="font-size: 8pt;" aria-label="Webcast (5 items)">Webcast</a>
<a href=".//tag/webinar" class="tag-cloud-link tag-link-125 tag-link-position-44" style="font-size: 12.430379746835pt;" aria-label="webinar (18 items)">webinar</a>
<a href=".//tag/windows" class="tag-cloud-link tag-link-127 tag-link-position-45" style="font-size: 9.0632911392405pt;" aria-label="Windows (7 items)">Windows</a>
</div>
</li>
<li id="theme_socialmedia-2" class="widget theme_socialmedia">			<div class="widget-social-icons">
				
			<a href="http://twitter.com/andrewmorgan"><img src=".//wp-content/themes/zeesynergie/images/icons/twitter.png" alt="twitter"></a><a href="http://www.facebook.com/andrewjamesmorgan"><img src=".//wp-content/themes/zeesynergie/images/icons/facebook.png" alt="facebook"></a><a href="https://plus.google.com/u/0/100605473697871424413/posts"><img src=".//wp-content/themes/zeesynergie/images/icons/googleplus.png" alt="googleplus"></a><a href="http://www.linkedin.com/profile/view?id=16709956"><img src=".//wp-content/themes/zeesynergie/images/icons/linkedin.png" alt="linkedin"></a><a href="http://www.flickr.com/photos/andrewjamesmorgan/"><img src=".//wp-content/themes/zeesynergie/images/icons/flickr.png" alt="flickr"></a><a href="http://www.youtube.com/channel/UCodtDakJ4VdeSCzS3P3rIsw"><img src=".//wp-content/themes/zeesynergie/images/icons/youtube.png" alt="youtube"></a>			</div>
		</li>
<li id="archives-2" class="widget widget_archive">
<h2 class="widgettitle">Archives</h2>

			<ul>
					<li><a href=".//2022/03">March 2022</a></li>
	<li><a href=".//2022/02">February 2022</a></li>
	<li><a href=".//2022/01">January 2022</a></li>
	<li><a href=".//2021/12">December 2021</a></li>
	<li><a href=".//2021/11">November 2021</a></li>
	<li><a href=".//2021/09">September 2021</a></li>
	<li><a href=".//2021/08">August 2021</a></li>
	<li><a href=".//2021/07">July 2021</a></li>
	<li><a href=".//2021/06">June 2021</a></li>
	<li><a href=".//2021/05">May 2021</a></li>
	<li><a href=".//2021/04">April 2021</a></li>
	<li><a href=".//2021/02">February 2021</a></li>
	<li><a href=".//2021/01">January 2021</a></li>
	<li><a href=".//2020/12">December 2020</a></li>
	<li><a href=".//2019/03">March 2019</a></li>
	<li><a href=".//2019/01">January 2019</a></li>
	<li><a href=".//2018/12">December 2018</a></li>
	<li><a href=".//2018/11">November 2018</a></li>
	<li><a href=".//2018/10">October 2018</a></li>
	<li><a href=".//2018/09">September 2018</a></li>
	<li><a href=".//2017/09">September 2017</a></li>
	<li><a href=".//2017/03">March 2017</a></li>
	<li><a href=".//2017/02">February 2017</a></li>
	<li><a href=".//2017/01">January 2017</a></li>
	<li><a href=".//2016/12">December 2016</a></li>
	<li><a href=".//2016/11">November 2016</a></li>
	<li><a href=".//2016/09">September 2016</a></li>
	<li><a href=".//2016/01">January 2016</a></li>
	<li><a href=".//2015/11" aria-current="page">November 2015</a></li>
	<li><a href=".//2015/10">October 2015</a></li>
	<li><a href=".//2015/09">September 2015</a></li>
	<li><a href=".//2015/06">June 2015</a></li>
	<li><a href=".//2015/04">April 2015</a></li>
	<li><a href=".//2015/03">March 2015</a></li>
	<li><a href=".//2015/02">February 2015</a></li>
	<li><a href=".//2015/01">January 2015</a></li>
	<li><a href=".//2014/12">December 2014</a></li>
	<li><a href=".//2014/11">November 2014</a></li>
	<li><a href=".//2014/10">October 2014</a></li>
	<li><a href=".//2014/09">September 2014</a></li>
	<li><a href=".//2014/08">August 2014</a></li>
	<li><a href=".//2014/07">July 2014</a></li>
	<li><a href=".//2014/06">June 2014</a></li>
	<li><a href=".//2014/05">May 2014</a></li>
	<li><a href=".//2014/04">April 2014</a></li>
	<li><a href=".//2014/03">March 2014</a></li>
	<li><a href=".//2014/02">February 2014</a></li>
	<li><a href=".//2014/01">January 2014</a></li>
	<li><a href=".//2013/12">December 2013</a></li>
	<li><a href=".//2013/11">November 2013</a></li>
	<li><a href=".//2013/09">September 2013</a></li>
	<li><a href=".//2013/08">August 2013</a></li>
	<li><a href=".//2013/07">July 2013</a></li>
	<li><a href=".//2013/06">June 2013</a></li>
	<li><a href=".//2013/05">May 2013</a></li>
	<li><a href=".//2013/03">March 2013</a></li>
	<li><a href=".//2013/02">February 2013</a></li>
	<li><a href=".//2013/01">January 2013</a></li>
	<li><a href=".//2012/12">December 2012</a></li>
	<li><a href=".//2012/11">November 2012</a></li>
	<li><a href=".//2012/09">September 2012</a></li>
	<li><a href=".//2012/07">July 2012</a></li>
	<li><a href=".//2012/06">June 2012</a></li>
	<li><a href=".//2012/05">May 2012</a></li>
	<li><a href=".//2012/04">April 2012</a></li>
	<li><a href=".//2012/03">March 2012</a></li>
	<li><a href=".//2012/02">February 2012</a></li>
	<li><a href=".//2012/01">January 2012</a></li>
	<li><a href=".//2011/12">December 2011</a></li>
	<li><a href=".//2011/11">November 2011</a></li>
	<li><a href=".//2011/10">October 2011</a></li>
	<li><a href=".//2011/09">September 2011</a></li>
	<li><a href=".//2011/07">July 2011</a></li>
	<li><a href=".//2011/06">June 2011</a></li>
	<li><a href=".//2011/05">May 2011</a></li>
	<li><a href=".//2011/04">April 2011</a></li>
	<li><a href=".//2011/03">March 2011</a></li>
	<li><a href=".//2011/02">February 2011</a></li>
	<li><a href=".//2011/01">January 2011</a></li>
	<li><a href=".//2010/12">December 2010</a></li>
	<li><a href=".//2010/11">November 2010</a></li>
	<li><a href=".//2010/10">October 2010</a></li>
	<li><a href=".//2010/09">September 2010</a></li>
	<li><a href=".//2010/08">August 2010</a></li>
	<li><a href=".//2010/07">July 2010</a></li>
	<li><a href=".//2010/06">June 2010</a></li>
	<li><a href=".//2010/05">May 2010</a></li>
	<li><a href=".//2010/04">April 2010</a></li>
	<li><a href=".//2010/03">March 2010</a></li>
	<li><a href=".//2010/02">February 2010</a></li>
	<li><a href=".//2010/01">January 2010</a></li>
	<li><a href=".//2009/12">December 2009</a></li>
	<li><a href=".//2009/11">November 2009</a></li>
	<li><a href=".//2009/10">October 2009</a></li>
	<li><a href=".//2009/09">September 2009</a></li>
	<li><a href=".//2009/08">August 2009</a></li>
	<li><a href=".//2009/07">July 2009</a></li>
	<li><a href=".//2009/06">June 2009</a></li>
	<li><a href=".//2009/05">May 2009</a></li>
	<li><a href=".//2009/04">April 2009</a></li>
			</ul>

			</li>
	
	</ul>
</div>	
	
	
	<div id="footer">
		<div id="foot">
			Supported by <a href="http://www.thievesgarden.co.uk" title="Maidenhead Accommodation - self catering apartment to rent" target="Thieves Garden">Thieves Garden - Maidenhead self catering apartment</a> and <a href="http://www.oleronvilla.com" title="Ile d'Oleron Holiday Home to rent" target="Oleron Villa">Oleron Villa holiday home on Ile d'Oleron</a>.			<div class="credit_link">	<a href="http://themezee.com/">Theme by ThemeZee</a>
</div>
			<div class="clear"></div>
		</div>
	</div>

	<!-- Powered by WPtouch: 4.3.39 -->
</html>